<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | APPcitas</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="app-container">
        <div class="nav">
            <div class="nav-info">
                <h1>APPcitas Dashboard</h1>
                <p class="subtitle" style="text-align: left; margin-bottom: 0;">Hola, <span id="cupidoName"
                        style="color: var(--primary); font-weight: 600;">...</span> ‚ú®</p>
            </div>
            <div class="nav-actions">
                <button onclick="openModal()" class="btn-main" style="background: #4ade80;">+ Nueva Sala</button>
                <button onclick="logout()" class="btn-main btn-glass">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'cupido')">Cupido</button>
            <button class="tab-btn" onclick="switchTab(event, 'chats')">Mis chats</button>
        </div>

        <!-- Cupido Tab -->
        <div id="cupido-tab" class="tab-content active">
            <div class="card-grid">
                <div class="stat-card">
                    <h3>Salas Totales</h3>
                    <div class="value" id="totalRooms">0</div>
                    <p style="font-size: 0.8rem; color: #4ade80;">Activas en el sistema</p>
                </div>
                <div class="stat-card">
                    <h3>Citas Pendientes</h3>
                    <div class="value" id="pendingRooms">0</div>
                    <p style="font-size: 0.8rem; color: #4ade80;">Esperando conexi√≥n</p>
                </div>
            </div>

            <div class="rooms-table-container">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Amigos</th>
                                <th>Links de Acceso</th>
                                <th>Estado Real-time</th>
                                <th style="text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 4rem; color: var(--text-dim);">
                                    Cargando salas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Mis Chats Tab -->
        <div id="chats-tab" class="tab-content" style="display: none;">
            <div id="recentsList" class="recents-grid"></div>
            <div id="noChatsMsg" style="padding: 5rem; text-align: center; display: none;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                <p style="color: var(--text-dim); font-size: 1.1rem;">No tienes chats guardados todav√≠a.</p>
                <p style="color: var(--text-dim); font-size: 0.9rem; margin-top: 0.5rem;">Aqu√≠ solo ver√°s los chats a
                    los que has sido invitado.</p>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Borrado -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3.5rem; margin-bottom: 1.5rem;">‚ö†Ô∏è</div>
            <h2 style="margin-bottom: 1rem; font-weight: 700;">¬øEst√°s seguro?</h2>
            <p style="color: var(--text-dim); margin-bottom: 2rem; line-height: 1.6;">Esta acci√≥n eliminar√°
                permanentemente la sala, todos los mensajes y los accesos de los invitados.</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="cancelDeleteBtn" class="btn-main btn-glass" style="flex: 1;">Cancelar</button>
                <button id="confirmDeleteBtn" class="btn-main" style="flex: 1; background: #ef4444;">Borrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Sala -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 2rem; text-align: center; font-weight: 700;">Crear Nueva Sala</h2>
            <form id="createRoomForm">
                <div class="form-row">
                    <div class="input-group">
                        <label>Nombre Amigo A</label>
                        <input type="text" id="friendA" required placeholder="Ej: Pedro">
                    </div>
                    <div class="input-group">
                        <label>Nombre Amigo B</label>
                        <input type="text" id="friendB" required placeholder="Ej: Sonia">
                    </div>
                </div>
                <button type="submit" class="btn-main" style="width: 100%; margin-top: 1rem;">Generar Sala y
                    Links</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;

        function switchTab(e, tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            e.currentTarget.classList.add('active');
            document.getElementById(`${tab}-tab`).style.display = 'block';
            if (tab === 'chats') loadRecents();
        }

        async function loadUser() {
            try {
                const res = await fetch('/api/user');
                if (!res.ok) throw new Error();
                const data = await res.json();
                currentUser = data;
                document.getElementById('cupidoName').innerText = data.username;
                // Important: Use the actual userId for socket room
                socket.emit('join-dashboard', { cupido_id: data.userId });
                loadRooms();
            } catch (err) { window.location.href = '/login'; }
        }

        async function loadRooms() {
            const res = await fetch('/api/rooms');
            const data = await res.json();
            const rooms = data.owned || [];

            document.getElementById('totalRooms').innerText = rooms.length;
            document.getElementById('pendingRooms').innerText = rooms.filter(r => r.status === 'pendiente').length;

            const tbody = document.getElementById('roomsTableBody');
            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding:4rem; color: var(--text-dim);">No hay salas creadas a√∫n. Dale al bot√≥n de arriba para empezar.</td></tr>';
                return;
            }

            tbody.innerHTML = rooms.map(room => `
                <tr id="room-${room.id}">
                    <td>
                        <div style="font-weight:700; font-size: 1.1rem; color: white;">${room.friendA_name} & ${room.friendB_name}</div>
                        <div style="font-size:0.8rem; color:var(--text-dim);">Creada el ${new Date(room.created_at).toLocaleDateString()}</div>
                    </td>
                    <td>
                        <div style="display:flex; gap:0.5rem; flex-wrap: wrap;">
                            <button class="copy-btn ${room.linkA_used ? 'btn-used' : ''}" style="flex:1; min-width: 120px;" onclick="copyToClipboard('${room.linkA}', this)">
                                ${room.linkA_used ? `Para ${room.friendA_name} (Usado)` : `Para ${room.friendA_name}`}
                            </button>
                            <button class="copy-btn ${room.linkB_used ? 'btn-used' : ''}" style="flex:1; min-width: 120px;" onclick="copyToClipboard('${room.linkB}', this)">
                                ${room.linkB_used ? `Para ${room.friendB_name} (Usado)` : `Para ${room.friendB_name}`}
                            </button>
                        </div>
                    </td>
                    <td><span class="badge badge-${room.status.toLowerCase().replace(/ /g, '')}">${room.status}</span></td>
                    <td style="text-align: right;">
                        <button onclick="deleteRoom(${room.id})" class="btn-main btn-glass" style="padding: 0.5rem 1rem; color: #ef4444; border-color: rgba(239, 68, 68, 0.2) !important;">Borrar</button>
                    </td>
                </tr>
            `).join('');
        }

        let roomToDelete = null;

        async function deleteRoom(id) {
            roomToDelete = id;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        document.getElementById('cancelDeleteBtn').onclick = () => {
            document.getElementById('confirmModal').style.display = 'none';
            roomToDelete = null;
        };

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!roomToDelete) return;
            try {
                const res = await fetch(`/api/rooms/${roomToDelete}`, { method: 'DELETE' });
                if (res.ok) {
                    loadRooms();
                    document.getElementById('confirmModal').style.display = 'none';
                    roomToDelete = null;
                } else {
                    const err = await res.json();
                    alert(err.error || "Error al borrar");
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexi√≥n");
            }
        };

        async function loadRecents() {
            const res = await fetch('/api/rooms');
            const data = await res.json();
            const accessed = data.accessed || [];

            const list = document.getElementById('recentsList');
            const msg = document.getElementById('noChatsMsg');

            if (accessed.length === 0) {
                msg.style.display = 'block';
                list.innerHTML = '';
            } else {
                msg.style.display = 'none';
                list.innerHTML = accessed.map(room => {
                    const link = (room.accessed_role === 'A') ? room.linkA : room.linkB;
                    const name = (room.accessed_role === 'A') ? room.friendB_name : room.friendA_name;
                    return `
                        <div class="recent-card" onclick="location.href='/chat/${link}'">
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">Chat con ${name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">Visto: ${new Date(room.accessed_at).toLocaleString()}</div>
                            <div style="position: absolute; right: 1.5rem; bottom: 1.5rem; opacity: 0.3;">üí¨</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function openModal() { document.getElementById('roomModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('roomModal').style.display = 'none'; }

        document.getElementById('createRoomForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch('/api/rooms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    friendA_name: document.getElementById('friendA').value,
                    friendB_name: document.getElementById('friendB').value
                })
            });
            if (res.ok) { closeModal(); loadRooms(); document.getElementById('createRoomForm').reset(); }
        };

        function copyToClipboard(text, btn) {
            const url = window.location.origin + '/chat/' + text;
            navigator.clipboard.writeText(url).then(() => {
                const old = btn.innerText;
                btn.innerText = '¬°Copiado!';
                btn.style.background = '#4ade80';
                setTimeout(() => {
                    btn.innerText = old;
                    btn.style.background = '';
                }, 2000);
            });
        }

        socket.on('status-change', ({ room_id, status }) => {
            const row = document.querySelector(`#room-${room_id}`);
            if (row) {
                const badge = row.cells[2].querySelector('.badge');
                badge.className = `badge badge-${status.toLowerCase().replace(/ /g, '')}`;
                badge.innerText = status;
            }
        });

        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.href = '/login'; }
        loadUser();
    </script>
</body>

</html>