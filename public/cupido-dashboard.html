<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cupido Dashboard | Gesti√≥n de Conexiones</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff4d6d">
    <link rel="apple-touch-icon" href="/app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1">Panel Cupido ‚ú®</h1>
            <div class="nav-actions">
                <button onclick="deleteAccount()" class="btn-main btn-danger fs-small">Borrar Cuenta</button>
                <button onclick="location.href='/dashboard'" class="btn-main btn-glass fs-small">Ver Salas</button>
                <button onclick="logout()" class="btn-main btn-glass fs-small">Salir</button>
            </div>
        </header>

        <main>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('rooms')">Mis Salas</button>
                <button class="tab-btn" onclick="switchTab('blinders')">Mis Blinders</button>
            </div>

            <div id="roomsView">
                <div id="roomsList">
                    <!-- Salas load here -->
                    <div style="text-align: center; color: var(--text-dim); padding: 3rem;">
                        Cargando salas...
                    </div>
                </div>
            </div>

            <div id="blindersView" style="display: none;">
                <div class="import-section glass-dashed p-2 mb-2 text-center">
                    <h3>Generar Invitaci√≥n Viral</h3>
                    <p class="fs-small mb-1 mt-1" style="color: var(--text-dim);">
                        Crea un enlace para que tus amigos se unan como Blindres.</p>
                    <button id="inviteBtn" onclick="generateInvite()" class="btn-main w-full">
                        <span>Generar Link de Invitaci√≥n</span>
                    </button>
                    <div id="inviteResult" class="mt-1" style="display: none;">
                        <input type="text" id="inviteUrl" readonly class="input-glass mb-1 fs-small text-center">
                        <button onclick="copyInvite()" class="btn-main btn-glass w-full">Copiar y Compartir</button>
                    </div>
                </div>

                <div id="blindersList">
                    <!-- Blinders load here -->
                    <div style="text-align: center; color: var(--text-dim); padding: 3rem;">
                        Cargando blinders...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const roomsList = document.getElementById('roomsList');
        const blindersList = document.getElementById('blindersList');

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('roomsView').style.display = 'none';
            document.getElementById('blindersView').style.display = 'none';

            if (tab === 'rooms') {
                document.querySelector('[onclick="switchTab(\'rooms\')"]').classList.add('active');
                document.getElementById('roomsView').style.display = 'block';
                loadRooms();
            } else if (tab === 'blinders') {
                document.querySelector('[onclick="switchTab(\'blinders\')"]').classList.add('active');
                document.getElementById('blindersView').style.display = 'block';
                loadBlinders();
            }
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms');
                const data = await res.json();
                roomsList.innerHTML = data.owned.map(r => `
                    <div class="room-card">
                        <div class="room-header">
                            <div class="room-names">${r.friendA_name} ‚Üî ${r.friendB_name}</div>
                            <div class="badge badge-${r.status.toLowerCase().replace(' ', '')}">${r.status}</div>
                        </div>
                        <div class="link-pills">
                            <div class="pill ${r.linkA_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkA}')">
                                <span>Rol A</span>
                                <span>Copiar</span>
                            </div>
                            <div class="pill ${r.linkB_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkB}')">
                                <span>Rol B</span>
                                <span>Copiar</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                if (data.owned.length === 0) roomsList.innerHTML = '<p style="text-align:center; padding: 3rem; color: var(--text-dim);">No hay salas activas todav√≠a.</p>';
            } catch (err) { console.error(err); }
        }


        async function loadBlinders() {
            try {
                const res = await fetch('/api/cupido/blinders');
                const blinders = await res.json();
                blindersList.innerHTML = blinders.map(b => `
                    <div class="room-card">
                        <div style="display: flex; align-items: center; gap: 1.2rem;">
                            <div style="width: 65px; height: 65px; border-radius: 50%; overflow: hidden; background: var(--glass); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;">
                                ${b.photo_url ? `<img src="${b.photo_url}" style="width:100%; height:100%; object-fit:cover;">` : '<span style="font-size: 1.5rem;">üë§</span>'}
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight: 700; font-size: 1.1rem;">${b.full_name} ${b.revealLevel >= 3 ? `(${b.age})` : ''}</div>
                                <div style="font-size: 0.85rem; color: var(--text-dim); font-style: italic; margin-top: 2px;">"${b.tagline}"</div>
                            </div>
                            <div class="badge badge-activo" style="font-size: 0.7rem;">Lvl ${b.revealLevel}</div>
                        </div>
                    </div>
                `).join('');
                if (blinders.length === 0) blindersList.innerHTML = '<p style="text-align:center; padding: 3rem; color: var(--text-dim);">A√∫n no tienes blinders invitados.</p>';
            } catch (err) { console.error(err); }
        }


        async function generateInvite() {
            const btn = document.getElementById('inviteBtn');
            btn.disabled = true;
            btn.innerText = "Generando...";

            try {
                const res = await fetch('/api/cupido/invite');
                const data = await res.json();
                const urlEl = document.getElementById('inviteUrl');
                urlEl.value = data.url;
                document.getElementById('inviteResult').style.display = 'block';
                btn.innerText = "¬°Link Generado!";
            } catch (err) {
                alert("Error al generar invitaci√≥n");
                btn.disabled = false;
                btn.innerText = "Generar Link de Invitaci√≥n";
            }
        }

        function copyInvite() {
            const url = document.getElementById('inviteUrl').value;
            if (navigator.share) {
                navigator.share({
                    title: '√önete a Cupido\'s Project',
                    text: 'Te invito a descubrir tus conexiones. ¬°√önete a mi red!',
                    url: url
                }).catch(() => {
                    navigator.clipboard.writeText(url);
                    alert("Link copiado al portapapeles.");
                });
            } else {
                navigator.clipboard.writeText(url);
                alert("Link copiado al portapapeles.");
            }
        }


        function copyUrl(path) {
            const fullUrl = window.location.origin + path;
            navigator.clipboard.writeText(fullUrl);
            alert("Enlace de chat copiado");
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu cuenta? Se eliminar√°n todas tus salas, tokens y blinders vinculados. Esta acci√≥n es definitiva.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) {
                    alert("Cuenta eliminada correctamente.");
                    location.href = '/login';
                } else {
                    alert("Error al eliminar la cuenta.");
                }
            }
        }

        async function logout() {

            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        // Initial Load
        switchTab('rooms');
    </script>
</body>

</html>