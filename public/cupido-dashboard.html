<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cupido Dashboard | Gesti√≥n de Conexiones</title>
    <link rel="stylesheet" href="/style.css?v=2.1">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff4d6d">
    <link rel="apple-touch-icon" href="/app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem;
            display: none;
            z-index: 100;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
            animation: premiumFadeIn 0.3s ease-out;
        }

        .dropdown-item {
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.danger {
            color: #ff4d6d;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 77, 109, 0.1);
        }

        /* Greeting Styles */
        .dashboard-header {
            padding: 0.5rem 0.5rem 1rem 0.5rem;
        }

        .dashboard-header h2 {
            font-weight: 800;
            letter-spacing: -0.5px;
            font-size: 1.8rem;
        }

        .text-gradient {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
    </style>

</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1" style="cursor: pointer;" onclick="location.href='/cupido-dashboard'">Panel
                Cupido ‚ú®</h1>
            <div class="nav-actions">
                <button id="headerProfileBtn" onclick="toggleProfile()" class="settings-btn" title="Perfil">üë§</button>
            </div>

        </header>

        <main>
            <!-- Views Container -->
            <div id="roomsView" class="view-section">
                <!-- Greeting Area -->
                <div class="dashboard-header mb-1">
                    <h2 class="mb-0" id="cupidoGreeting">Hola, Cupido üëã</h2>
                    <p class="text-dim">Gestiona tus flechazos activos.</p>
                </div>

                <div class="p-2 mb-2 glass-dashed text-center">
                    <button onclick="openModal()" class="btn-main w-full">
                        <span>+ Nueva Conexi√≥n</span>
                    </button>
                </div>
                <div id="roomsList">
                    <!-- Salas load here -->
                    <div class="text-center text-dim p-3">
                        Cargando salas...
                    </div>
                </div>
            </div>

            <div id="blindersView" class="view-section" style="display: none;">
                <div class="import-section glass-dashed p-2 mb-2 text-center">
                    <h3>Generar Invitaci√≥n Viral</h3>
                    <p class="fs-small mb-1 mt-1 text-dim">
                        Crea un enlace para que tus amigos se unan como Blindres.</p>
                    <button id="inviteBtn" onclick="generateInvite()" class="btn-main w-full">
                        <span>Generar Link de Invitaci√≥n</span>
                    </button>
                    <div id="inviteResult" class="mt-1 hidden">
                        <input type="text" id="inviteUrl" readonly class="input-glass mb-1 fs-small text-center">
                        <button onclick="copyInvite()" class="btn-main btn-glass w-full">Copiar y Compartir</button>
                    </div>

                </div>

                <div id="blindersList">
                    <!-- Blinders load here -->
                    <div class="text-center text-dim p-3">
                        Cargando blinders...
                    </div>
                </div>

            </div>


            <div id="profileView" class="view-section" style="display: none;">
                <div class="text-center mb-2 mt-1">
                    <div
                        style="width: 80px; height: 80px; margin: 0 auto 10px; background: var(--glass); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border: 2px solid var(--border);">
                        üë§</div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 0px;">Mi Perfil</h2>
                    <p class="text-dim fs-small">Configuraci√≥n de cuenta</p>
                </div>

                <div id="pwaInstallArea" class="compact-card" style="display:none;">
                    <div class="icon">üì≤</div>
                    <div class="content">
                        <h3>Instalar App</h3>
                        <p>Acceso r√°pido en inicio</p>
                    </div>
                    <button id="installBtn" class="btn-main"
                        style="padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 12px;">Instalar</button>
                </div>

                <div id="pushArea" class="compact-card" style="display:none;">
                    <div class="icon">üîî</div>
                    <div class="content">
                        <h3>Notificaciones</h3>
                        <p>Activa alertas de chat</p>
                    </div>
                    <button id="pushBtn" onclick="subscribeToPush()" class="btn-main"
                        style="padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 12px;">Activar</button>
                </div>

                <div class="compact-card" onclick="logout()" style="cursor: pointer;">
                    <div class="icon">üö™</div>
                    <div class="content">
                        <h3>Cerrar Sesi√≥n</h3>
                        <p>Salir de tucocuenta</p>
                    </div>
                    <div style="color: var(--text-dim);">‚Ä∫</div>
                </div>

                <div class="compact-card" onclick="deleteAccount()"
                    style="cursor: pointer; border-color: rgba(239, 68, 68, 0.3);">
                    <div class="icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">‚ö†Ô∏è</div>
                    <div class="content">
                        <h3>Eliminar Cuenta</h3>
                        <p style="color: #ef4444;">Acci√≥n irreversible</p>
                    </div>
                </div>

                <div class="text-center mt-2">
                    <p class="fs-small text-dim">Cupido's Project v2.0</p>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('rooms')">
                <span class="nav-icon">üí¨</span>
                <span>Salas</span>
            </button>
            <button class="nav-item" onclick="switchTab('blinders')">
                <span class="nav-icon">üë•</span>
                <span>Blinders</span>
            </button>
            <button class="nav-item" onclick="switchTab('profile')">
                <span class="nav-icon">üë§</span>
                <span>Perfil</span>
            </button>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div id="roomModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div class="premium-card" style="max-width: 90%; width: 400px; margin: 0; position: relative;">
            <span class="close-modal" onclick="closeModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer;">&times;</span>
            <h2 style="margin-bottom: 2rem; text-align: center; font-weight: 700;">Nueva Conexi√≥n</h2>
            <form id="createRoomForm">
                <div class="input-group">
                    <label>Persona A</label>
                    <input type="text" id="friendA" required placeholder="Ej: Juan">
                </div>
                <div class="input-group">
                    <label>Persona B</label>
                    <input type="text" id="friendB" required placeholder="Ej: Sonia">
                </div>
                <button type="submit" class="btn-main w-full mt-1">Crear Sala</button>
            </form>
        </div>
    </div>

    <!-- PWA Install Popup -->
    <div id="pwaModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
        <div class="premium-card text-center"
            style="max-width: 90%; width: 350px; margin: 0; animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div id="pwaIcon" style="font-size: 3rem; margin-bottom: 0.5rem;">üì≤</div>
            <h2 class="mb-1">Mejor Experiencia</h2>
            <p class="text-dim mb-2 fs-small">Instala la App para recibir notificaciones y acceder sin internet.</p>

            <button id="pwaInstallBtn" class="btn-main w-full mb-1">
                Instalar App
            </button>
            <button onclick="dismissPwa()" class="btn-main w-full btn-glass">
                Seguir en Navegador
            </button>
        </div>
    </div>

    <!-- Room Info Modal -->
    <div id="infoModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center;">
        <div class="premium-card" style="max-width: 90%; width: 350px; margin: 0; position: relative;">
            <span class="close-modal" onclick="closeInfoModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer;">&times;</span>
            <h2 class="mb-2 text-center">Detalles de Sala</h2>

            <div id="infoContent" style="text-align: left;">
                <!-- Content injected via JS -->
            </div>

            <button onclick="closeInfoModal()" class="btn-main w-full mt-2">Cerrar</button>
        </div>
    </div>

    <!-- Secret Spy Modal -->
    <div id="secretModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; align-items: center; justify-content: center;">
        <div class="premium-card"
            style="max-width: 95%; width: 400px; margin: 0; position: relative; border: 1px solid #ff4d6d; box-shadow: 0 0 30px rgba(255, 77, 109, 0.2);">
            <span class="close-modal" onclick="closeSecretModal()"
                style="position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer;">&times;</span>

            <div class="text-center mb-2">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üïµÔ∏è‚Äç‚ôÄÔ∏è</div>
                <h2 style="color: #ff4d6d; text-transform: uppercase; letter-spacing: 1px; font-size: 1.2rem;">Modo
                    Esp√≠a</h2>
                <p class="text-dim fs-small">Accede al feed de mensajes en tiempo real.</p>
            </div>

            <div id="secretChatArea"
                style="background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; height: 200px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border); position: relative;">
                <div id="secretMessagesList"
                    style="display: flex; flex-direction: column; gap: 10px; padding-bottom: 10px; transition: filter 0.3s; filter: blur(12px); user-select: none;">
                </div>
                <div id="secretOverlay"
                    style="position: absolute; top:0; left:0; width:100%; height:100%; display: flex; align-items: center; justify-content: center; z-index: 100; pointer-events: none;">
                    <span style="font-size: 3rem; text-shadow: 0 0 20px black;">üîí</span>
                </div>
            </div>

            <div class="text-center">
                <div id="timerArea" style="display: none; margin-bottom: 10px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #ff4d6d;" id="spyTimer">10</div>
                    <small class="text-dim">segundos restantes</small>
                </div>

                <p id="quotaText" class="fs-small text-dim mb-1">Consultando disponibilidad...</p>

                <button id="activateSpyBtn" onclick="activateSpyMode()" class="btn-main w-full"
                    style="background: linear-gradient(135deg, #ff4d6d 0%, #ff8fa3 100%);">
                    üëÅÔ∏è DESVELAR AHORA
                </button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const roomsList = document.getElementById('roomsList');
        const blindersList = document.getElementById('blindersList');
        let currentRooms = [];

        // Identify for Global Notifications
        fetch('/api/user').then(r => r.json()).then(user => {
            if (user.userId) {
                socket.emit('join-user', { userId: user.userId });
                socket.emit('join-dashboard', { cupido_id: user.userId });
            }
            if (user.username) {
                document.getElementById('cupidoGreeting').innerHTML = `Hola, <span class="text-gradient">${user.username}</span> üëã`;
            }
        }).catch(e => console.warn(e));

        // Modal Logic
        function openModal() { document.getElementById('roomModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('roomModal').style.display = 'none'; }
        function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; }

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.closeInfoModal = closeInfoModal;
        window.showRoomInfo = showRoomInfo;

        // Prevent Back Navigation
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('show');
        }

        window.onclick = function (event) {
            if (!event.target.matches('.settings-btn')) {
                const menu = document.getElementById('settingsMenu');
                if (menu && menu.classList.contains('show')) menu.classList.remove('show');
            }
        }

        function toggleProfile() {
            const profileView = document.getElementById('profileView');
            if (profileView.style.display !== 'none') {
                switchTab('rooms');
            } else {
                switchTab('profile');
            }
        }

        // Haptic Feedback Helper
        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function switchTab(tab) {
            const updateTab = () => {
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                if (tab === 'rooms') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if (tab === 'blinders') document.querySelectorAll('.nav-item')[1].classList.add('active');
                if (tab === 'profile') document.querySelectorAll('.nav-item')[2].classList.add('active');

                document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

                const headerBtn = document.getElementById('headerProfileBtn');

                if (tab === 'rooms') {
                    document.getElementById('roomsView').style.display = 'block';
                    if (headerBtn) headerBtn.innerText = 'üë§';
                    loadRooms();
                } else if (tab === 'blinders') {
                    document.getElementById('blindersView').style.display = 'block';
                    if (headerBtn) headerBtn.innerText = 'üë§';
                    loadBlinders();
                } else if (tab === 'profile') {
                    document.getElementById('profileView').style.display = 'block';
                    if (headerBtn) headerBtn.innerText = '‚úï';
                }
                triggerHaptic();
            };

            if (document.startViewTransition) {
                document.startViewTransition(updateTab);
            } else {
                updateTab();
            }
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms');
                const data = await res.json();

                if (data.my_id) {
                    socket.emit('join-dashboard', { cupido_id: data.my_id });
                }

                const allRooms = [...data.owned, ...(data.accessed || [])];

                if (allRooms.length === 0) {
                    roomsList.innerHTML = `
                    <div class="text-center p-3">
                        <div class="hero-emoji">üåµ</div>
                        <h2 class="mb-1">A√∫n no hay salas</h2>
                        <p class="text-dim mb-2">¬°Crea tu primera sala para empezar!</p>
                        <button onclick="openModal()" class="btn-main w-full">Crear Sala</button>
                    </div>`;
                    return;
                }

                currentRooms = allRooms; // Cache for socket updates

                roomsList.innerHTML = allRooms.map(r => {
                    const bothUsed = r.linkA_used && r.linkB_used;
                    let actionArea = '';

                    if (bothUsed) {
                        const msgText = r.last_message ? r.last_message.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "Esperando primer mensaje...";

                        // Determine sender name
                        let senderLabel = "";
                        if (r.last_sender === 'A') senderLabel = `${r.friendA_name}:`;
                        else if (r.last_sender === 'B') senderLabel = `${r.friendB_name}:`;

                        actionArea = `
                            <div class="sneak-peek-container" id="preview-${r.id}" style="background: rgba(0,0,0,0.2); border-radius: 16px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); margin: 10px 0; position: relative; overflow: hidden;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 6px; display: flex; align-items: center; gap: 5px;">
                                    <span>üëÄ</span> Vistazo r√°pido
                                </div>
                                <div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    <span id="preview-sender-${r.id}" style="font-weight: bold; color: var(--primary); margin-right: 4px;">${senderLabel}</span>
                                    <span id="preview-msg-${r.id}" style="font-style: italic; color: rgba(255,255,255,0.8); filter: blur(6px); user-select: none; pointer-events: none;">${msgText}</span>
                                </div>
                                <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: linear-gradient(to top, rgba(20,20,20,0.5), transparent);"></div>
                                <button onclick="openSecretModal('${r.id}')" style="position: absolute; bottom: 8px; right: 12px; font-size: 0.65rem; color: white; background: #ff4d6d; border: none; padding: 4px 10px; border-radius: 6px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; z-index: 5; box-shadow: 0 4px 10px rgba(255, 77, 109, 0.3);">
                                    üîê Top Secret
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 5px;">
                                <button onclick="copyUrl('/chat/${r.linkA}')" class="btn-text-only" style="font-size: 0.7rem; color: var(--text-dim); background: none; border: none; cursor: pointer; text-decoration: underline;">Link ${r.friendA_name}</button>
                                <span style="color: var(--border);">|</span>
                                <button onclick="copyUrl('/chat/${r.linkB}')" class="btn-text-only" style="font-size: 0.7rem; color: var(--text-dim); background: none; border: none; cursor: pointer; text-decoration: underline;">Link ${r.friendB_name}</button>
                            </div>
                        `;
                    } else {
                        actionArea = `
                            <div class="link-pills">
                                <div class="pill ${r.linkA_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkA}')">
                                    <span>${r.friendA_name}</span>
                                    <span>${r.linkA_used ? '‚úÖ Unido' : 'Copiar Link'}</span>
                                </div>
                                <div class="pill ${r.linkB_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkB}')">
                                    <span>${r.friendB_name}</span>
                                    <span>${r.linkB_used ? '‚úÖ Unido' : 'Copiar Link'}</span>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="room-card" id="room-${r.id}">
                            <div class="room-header">
                                <div class="room-names">${r.friendA_name} ‚Üî ${r.friendB_name}</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div class="badge badge-${r.status.toLowerCase().replace(' ', '')}" id="status-${r.id}">${r.status}</div>
                                    <button onclick="event.stopPropagation(); showRoomInfo('${r.id}')" style="background: rgba(255,255,255,0.15); border: 1px solid var(--border); border-radius: 50%; width: 44px; height: 44px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: transform 0.2s; position: relative; z-index: 10;">‚ÑπÔ∏è</button>
                                </div>
                            </div>
                            ${actionArea}
                            <button onclick="shareRoom('${r.id}')" class="btn-main btn-glass w-full mt-1" style="font-size: 0.9rem; padding: 0.6rem;">
                                üîó Compartir Acceso a Sala
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error("Error al cargar salas:", err);
            }
        }

        // Real-time Preview Update
        socket.on('preview-update', (data) => {
            const { room_id, text, sender } = data;

            // 1. Update List Card
            const msgField = document.getElementById(`preview-msg-${room_id}`);
            const senderField = document.getElementById(`preview-sender-${room_id}`);
            const container = document.getElementById(`preview-${room_id}`);

            if (msgField && container) {
                const room = currentRooms.find(r => r.id === room_id);
                let senderName = '';
                if (room) {
                    if (sender === 'A') senderName = `${room.friendA_name}:`;
                    else if (sender === 'B') senderName = `${room.friendB_name}:`;
                }

                if (senderField) senderField.innerText = senderName;
                msgField.innerText = text;

                // Visual Pulse
                container.style.transition = 'box-shadow 0.2s, transform 0.2s';
                container.style.boxShadow = '0 0 15px rgba(255, 77, 109, 0.6)';
                container.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    container.style.boxShadow = 'none';
                    container.style.transform = 'scale(1)';
                }, 300);
            }

            // 2. Update Spy Modal if Active
            if (activeSpyRoomId == room_id && isSpyActive) {
                addSecretMessage(text, sender, true);
            }
        });

        // --- SPY MODE LOGIC ---
        let activeSpyRoomId = null;
        let isSpyActive = false;
        let spyTimerInterval = null;

        async function openSecretModal(roomId) {
            activeSpyRoomId = roomId;
            isSpyActive = false; // Reset live state

            // Reset UI
            document.getElementById('secretMessagesList').style.filter = "blur(12px)";
            document.getElementById('secretOverlay').style.display = 'flex';

            document.getElementById('secretMessagesList').innerHTML = '<div class="spinner"></div>';
            document.getElementById('timerArea').style.display = 'none';
            document.getElementById('activateSpyBtn').disabled = true;
            document.getElementById('activateSpyBtn').style.display = 'inline-block';
            document.getElementById('quotaText').innerText = 'Consultando disponibilidad...';

            document.getElementById('secretModal').style.display = 'flex';

            try {
                // 1. Get Quota
                const quotaRes = await fetch('/api/cupido/spy-status');
                const quotaData = await quotaRes.json();

                document.getElementById('activateSpyBtn').disabled = (quotaData.remaining <= 0);
                document.getElementById('quotaText').innerText = `Intentos restantes hoy: ${quotaData.remaining}/3`;

                if (quotaData.remaining <= 0) {
                    document.getElementById('activateSpyBtn').innerText = "CUPO AGOTADO";
                    document.getElementById('activateSpyBtn').style.background = "#555";
                } else {
                    document.getElementById('activateSpyBtn').innerText = "üëÅÔ∏è DESVELAR (10s)";
                    document.getElementById('activateSpyBtn').style.background = "linear-gradient(135deg, #ff4d6d 0%, #ff8fa3 100%)";
                }

                // 2. Get Last 3 Messages
                const msgsRes = await fetch(`/api/rooms/${roomId}/peek`);
                const msgs = await msgsRes.json();

                const list = document.getElementById('secretMessagesList');
                list.innerHTML = '';

                msgs.forEach(m => addSecretMessage(m.text, m.sender, false));

            } catch (err) {
                console.error(err);
                document.getElementById('secretMessagesList').innerHTML = '<p class="text-danger">Error cargando datos.</p>';
            }
        }

        function addSecretMessage(text, senderLabel, isLive) {
            const room = currentRooms.find(r => r.id == activeSpyRoomId);
            let name = senderLabel;
            if (room) {
                if (senderLabel === 'A') name = room.friendA_name;
                else if (senderLabel === 'B') name = room.friendB_name;
            }

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.width = '100%';
            // Validate sender to avoid crash if something else comes in
            const isA = (senderLabel === 'A');
            const isB = (senderLabel === 'B');

            // Align: A left, B right. If unknown, center or left.
            if (isB) wrapper.style.justifyContent = 'flex-end';
            else wrapper.style.justifyContent = 'flex-start';

            const div = document.createElement('div');
            div.style.maxWidth = '85%';
            div.style.padding = '10px';
            div.style.borderRadius = '12px';
            div.style.marginBottom = '2px';
            div.style.position = 'relative';

            // Colors
            if (isA) {
                div.style.background = 'rgba(255, 77, 109, 0.2)'; // Pinkish for A
                div.style.border = '1px solid rgba(255, 77, 109, 0.3)';
                div.style.borderBottomLeftRadius = '2px';
            } else if (isB) {
                div.style.background = 'rgba(78, 205, 196, 0.2)'; // Teal for B
                div.style.border = '1px solid rgba(78, 205, 196, 0.3)';
                div.style.borderBottomRightRadius = '2px';
            } else {
                div.style.background = 'rgba(255, 255, 255, 0.1)';
            }

            // Live Highlight
            if (isLive) {
                div.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.3)';
                div.style.border = '1px solid #fff';
                div.style.animation = 'premiumFadeIn 0.3s ease-out';
            }

            div.innerHTML = `
                <div style="font-size: 0.7rem; color: #ddd; margin-bottom: 3px; font-weight: bold; text-align: ${isB ? 'right' : 'left'};">
                    ${isLive ? 'üî¥ ' : ''}${name}
                </div>
                <div style="font-size: 0.95rem; line-height: 1.4;">${text}</div>
            `;

            wrapper.appendChild(div);
            document.getElementById('secretMessagesList').appendChild(wrapper);

            // Scroll to bottom
            const area = document.getElementById('secretChatArea');
            setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
        }

        async function activateSpyMode() {
            if (!activeSpyRoomId) return;
            const btn = document.getElementById('activateSpyBtn');
            btn.disabled = true;
            btn.innerText = "Activando...";

            try {
                const res = await fetch('/api/cupido/spy-consume', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    // Success!
                    isSpyActive = true;
                    document.getElementById('secretMessagesList').style.filter = "none"; // UNBLUR
                    document.getElementById('secretOverlay').style.display = 'none'; // Hide lock

                    document.getElementById('timerArea').style.display = 'block';
                    document.getElementById('activateSpyBtn').style.display = 'none'; // Hide button logic

                    let timeLeft = 10;
                    document.getElementById('spyTimer').innerText = timeLeft;

                    if (spyTimerInterval) clearInterval(spyTimerInterval);
                    spyTimerInterval = setInterval(() => {
                        timeLeft--;
                        document.getElementById('spyTimer').innerText = timeLeft;
                        if (timeLeft <= 0) {
                            endSpyMode();
                        }
                    }, 1000);

                } else {
                    alert(data.error || "No se pudo activar.");
                    btn.disabled = false;
                    btn.innerText = "Reintentar";
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n");
                btn.disabled = false;
            }
        }

        function endSpyMode() {
            clearInterval(spyTimerInterval);
            isSpyActive = false;

            document.getElementById('secretMessagesList').style.filter = "blur(12px)"; // REBLUR
            document.getElementById('secretOverlay').style.display = 'flex';

            document.getElementById('timerArea').style.display = 'none';
            document.getElementById('activateSpyBtn').style.display = 'inline-block';
            document.getElementById('activateSpyBtn').innerText = "TIEMPO AGOTADO";
            document.getElementById('activateSpyBtn').disabled = true;

            closeSecretModal();
        }

        function closeSecretModal() {
            document.getElementById('secretModal').style.display = 'none';
            activeSpyRoomId = null;
            isSpyActive = false;
            if (spyTimerInterval) clearInterval(spyTimerInterval);
        }

        async function shareRoom(roomId) {
            try {
                const res = await fetch(`/api/rooms/${roomId}/share`, { method: 'POST' });
                if (!res.ok) return alert("Error al generar enlace.");
                const data = await res.json();
                if (data.url) {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Acceso a Sala - Cupido',
                                text: 'Enlace de acceso para colaborar en esta sala:',
                                url: data.url
                            });
                            return;
                        } catch (err) { }
                    }
                    await navigator.clipboard.writeText(data.url);
                    triggerHaptic();
                    alert("Enlace copiado al portapapeles.");
                }
            } catch (e) { console.error(e); }
        }

        async function showRoomInfo(roomId) {
            console.log('showRoomInfo called with ID:', roomId);

            // Initial loading state
            document.getElementById('infoContent').innerHTML = '<div class="text-center p-3"><div class="spinner"></div><p class="text-dim fs-small mt-1">Sincronizando...</p></div>';
            document.getElementById('infoModal').style.display = 'flex';

            try {
                const res = await fetch(`/api/rooms/${roomId}`);
                if (!res.ok) throw new Error("Error fetching room");
                const room = await res.json();

                const createdDate = new Date(room.created_at).toLocaleDateString();
                const stats = room.stats || { total_messages: 0, msgs_A: 0, msgs_B: 0, ratio_A: 0, ratio_B: 0 };
                const activeTime = room.active_time_str || "0m";

                // Inactivity Logic
                let inactivityHtml = '';
                // Determine last significant activity
                const createdTime = new Date(room.created_at).getTime();
                const lastMsgTime = room.last_message_time ? new Date(room.last_message_time).getTime() : 0;

                // Default to creation time, upgrade to last message if newer
                let lastActivityTimestamp = Math.max(createdTime, lastMsgTime);

                // If room is currently active, reset inactivity timer to NOW
                if (room.active_since) {
                    lastActivityTimestamp = Date.now();
                }

                const diffMs = Date.now() - lastActivityTimestamp;
                const daysInactive = diffMs / (1000 * 60 * 60 * 24);

                if (daysInactive > 3) {
                    const daysLeft = 5 - daysInactive; // 5 days total life before deletion? User said "warn at 3 days that it will be deleted in 2 days" -> 3+2=5.
                    let timeString = "";
                    if (daysLeft > 1) {
                        timeString = Math.floor(daysLeft) + " d√≠as";
                    } else if (daysLeft > 0) {
                        const hours = Math.floor(daysLeft * 24);
                        timeString = hours + " horas";
                    } else {
                        timeString = "breve";
                    }

                    inactivityHtml = `
                        <div style="background: rgba(255, 77, 109, 0.1); border: 1px solid rgba(255, 77, 109, 0.3); padding: 10px; border-radius: 12px; margin-bottom: 1rem; text-align: center;">
                            <div style="color: #ff4d6d; font-weight: bold; font-size: 0.9rem; margin-bottom: 4px;">‚ö†Ô∏è Auto-Destrucci√≥n</div>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-dim);">Sala inactiva. Eliminaci√≥n en <strong style="color: #ff4d6d;">${timeString}</strong>.</p>
                        </div>
                     `;
                }

                document.getElementById('infoContent').innerHTML = `
                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid var(--border);">
                        ${inactivityHtml}
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                             <div>
                                <p class="mb-1"><strong class="text-dim">ID Sala:</strong> <span style="font-family: monospace;">${room.id}</span></p>
                                <p class="mb-1"><strong class="text-dim">Creada:</strong> ${createdDate}</p>
                                <p class="mb-1"><strong class="text-dim">Estado:</strong> <span class="badge badge-${room.status.toLowerCase().replace(' ', '')}" style="font-size: 0.8em; padding: 2px 8px;">${room.status}</span></p>
                             </div>
                             <button onclick="deleteRoom('${room.id}')" title="Eliminar Sala" style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;">
                                üóëÔ∏è
                             </button>
                        </div>
                        <hr style="border: 0; border-top: 1px solid var(--border); margin: 0.8rem 0;">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1rem;">
                            <div class="glass-card p-1 text-center" style="background: rgba(255,255,255,0.05);">
                                <div style="font-size: 1.2rem;">‚è±Ô∏è</div>
                                <small class="text-dim">Tiempo Activo</small>
                                <div style="font-weight: bold;">${activeTime}</div>
                            </div>
                            <div class="glass-card p-1 text-center" style="background: rgba(255,255,255,0.05);">
                                <div style="font-size: 1.2rem;">üí¨</div>
                                <small class="text-dim">Mensajes</small>
                                <div style="font-weight: bold;">${stats.total_messages}</div>
                            </div>
                        </div>

                        <div class="mb-1">
                            <strong class="text-dim" style="display:block; margin-bottom: 0.5rem;">üó£Ô∏è Ratio de Conversaci√≥n</strong>
                            
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px;">
                                <span>‚ú® ${room.friendA_name} (${stats.ratio_A}%)</span>
                                <span>üî• ${room.friendB_name} (${stats.ratio_B}%)</span>
                            </div>
                            <div style="height: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; display: flex;">
                                <div style="width: ${stats.ratio_A}%; background: #ff4d6d; height: 100%;"></div>
                                <div style="width: ${stats.ratio_B}%; background: #4ecdc4; height: 100%;"></div>
                            </div>
                             <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-dim); margin-top: 4px;">
                                <span>${stats.msgs_A} msgs</span>
                                <span>${stats.msgs_B} msgs</span>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error(err);
                document.getElementById('infoContent').innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-danger">No se pudo cargar la informaci√≥n actualizada.</p>
                        <button onclick="closeInfoModal()" class="btn-main btn-glass mt-1">Cerrar</button>
                    </div>
                `;
            }
        }

        async function deleteRoom(roomId) {
            if (!confirm("‚ö†Ô∏è ¬øEliminar sala definitivamente?\n\nEsta acci√≥n borrar√° todo el historial y desconectar√° a los blinders.")) return;

            // Visual feedback
            const btn = event.currentTarget || document.activeElement;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="spinner" style="width:14px; height:14px; border-width:2px;"></div>';
            btn.disabled = true;

            try {
                const res = await fetch(`/api/rooms/${roomId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeInfoModal();
                    loadRooms();
                } else {
                    alert("No se pudo eliminar la sala.");
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexi√≥n.");
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function loadBlinders() {
            try {
                const res = await fetch('/api/cupido/blinders');
                const blinders = await res.json();
                blindersList.innerHTML = blinders.map(b => `
                    <div class="room-card">
                        <div style="display: flex; align-items: center; gap: 1.2rem;">
                            <div style="width: 65px; height: 65px; border-radius: 50%; overflow: hidden; background: var(--glass); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;">
                                ${b.photo_url ? `<img src="${b.photo_url}" style="width:100%; height:100%; object-fit:cover;">` : '<span style="font-size: 1.5rem;">üë§</span>'}
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight: 700; font-size: 1.1rem;">${b.full_name} ${b.revealLevel >= 3 ? `(${b.age})` : ''}</div>
                                <div style="font-size: 0.85rem; color: var(--text-dim); font-style: italic; margin-top: 2px;">"${b.tagline}"</div>
                            </div>
                            <div class="badge badge-activo" style="font-size: 0.7rem;">Lvl ${b.revealLevel || 1}</div>
                        </div>
                    </div>
                `).join('');
                if (blinders.length === 0) {
                    blindersList.innerHTML = `
                        <div class="text-center p-3">
                            <div class="empty-state-icon">üëª</div>
                            <p class="text-dim">No tienes blinders a√∫n.</p>
                            <p class="fs-small text-dim">¬°Comparte tu link viral para atraer solteros!</p>
                        </div>`;
                }
            } catch (err) { console.error(err); }
        }

        async function generateInvite() {
            const btn = document.getElementById('inviteBtn');
            btn.disabled = true;
            btn.innerText = "Generando...";
            try {
                const res = await fetch('/api/cupido/invite');
                const data = await res.json();
                document.getElementById('inviteUrl').value = data.url;
                document.getElementById('inviteResult').style.display = 'block';
                btn.innerText = "¬°Link Generado!";
            } catch (err) {
                alert("Error al generar invitaci√≥n");
                btn.disabled = false;
                btn.innerText = "Generar Link de Invitaci√≥n";
            }
        }

        function copyInvite() {
            const url = document.getElementById('inviteUrl').value;
            navigator.clipboard.writeText(url);
            triggerHaptic();
            alert("Link copiado al portapapeles.");
        }

        function copyUrl(path) {
            const fullUrl = window.location.origin + path;
            navigator.clipboard.writeText(fullUrl);
            triggerHaptic();
            alert("Enlace de chat copiado");
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu cuenta? Esta acci√≥n es definitiva.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) location.href = '/login';
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        document.getElementById('createRoomForm').onsubmit = async (e) => {
            e.preventDefault();
            const friendA = document.getElementById('friendA').value;
            const friendB = document.getElementById('friendB').value;
            try {
                const res = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ friendA_name: friendA, friendB_name: friendB })
                });
                if (res.ok) {
                    closeModal();
                    loadRooms();
                    e.target.reset();
                }
            } catch (e) { }
        };

        socket.on('status-change', ({ room_id, status }) => {
            const badge = document.getElementById(`status-${room_id}`);
            if (badge) {
                badge.innerText = status;
                badge.className = `badge badge-${status.toLowerCase().replace(' ', '')}`;
            }
        });

        socket.on('link-regenerated', ({ room_id }) => {
            if (document.getElementById('roomsView').style.display === 'block') loadRooms();
        });

        // PWA logic simplified
        let deferredPrompt;
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        function dismissPwa() { document.getElementById('pwaModal').style.display = 'none'; sessionStorage.setItem('pwaDismissed', 'true'); }
        function showManualInstructions() {
            const modal = document.getElementById('pwaModal');
            document.getElementById('pwaIcon').innerHTML = isIos ? 'üçè' : 'üì≤';
            modal.querySelector('h2').innerText = isIos ? "Instalar en iPhone" : "Instalar App";
            modal.querySelector('p').innerHTML = isIos ? "Toca <b>Compartir</b> y selecciona <b>'A√±adir al inicio'</b>" : "Usa el men√∫ del navegador para instalar.";
            document.getElementById('pwaInstallBtn').innerText = "Entendido";
            document.getElementById('pwaInstallBtn').onclick = dismissPwa;
            modal.style.display = 'flex';
        }

        if (!isStandalone) document.getElementById('pwaInstallArea').style.display = 'block';
        document.getElementById('installBtn').onclick = () => { if (deferredPrompt) deferredPrompt.prompt(); else showManualInstructions(); };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!sessionStorage.getItem('pwaDismissed') && !isStandalone) {
                setTimeout(() => { document.getElementById('pwaModal').style.display = 'flex'; }, 2000);
            }
        });

        // Push functions
        async function subscribeToPush() {
            try {
                const keyRes = await fetch('/api/vapid-key');
                const { publicKey } = await keyRes.json();
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) });
                await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify(sub), headers: { 'Content-Type': 'application/json' } });
                alert("¬°Notificaciones activadas! üîî");
                document.getElementById('pushArea').style.display = 'none';
            } catch (err) { console.error(err); }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        (async () => {
            if ('serviceWorker' in navigator && 'PushManager' in window && Notification.permission !== 'denied') {
                const reg = await navigator.serviceWorker.ready;
                if (!(await reg.pushManager.getSubscription())) document.getElementById('pushArea').style.display = 'block';
            }
        })();

        // Check for Room Invite
        async function checkJoinRoom() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('join_room');
            if (!token) return;

            try {
                const res = await fetch('/api/rooms/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await res.json();

                if (res.ok) {
                    alert(data.message || "¬°Te has unido a la sala!");
                    // Remove param from URL
                    const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                    loadRooms();
                } else {
                    console.error("Join error:", data);
                    // alert("Error al unirse: " + (data.error || "Desconocido"));
                }
            } catch (err) {
                console.error("Join request failed", err);
            }
        }
        checkJoinRoom();

        switchTab('rooms');
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW error:', err));
            });
        }
    </script>
    <script src="/notifications.js"></script>
</body>

</html>