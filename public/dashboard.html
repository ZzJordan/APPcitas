<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | APPcitas</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff4d6d">
    <link rel="apple-touch-icon" href="/app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="app-container">
        <div class="nav">
            <div class="nav-info">
                <h1>APPcitas Dashboard</h1>
                <p class="subtitle" style="text-align: left; margin-bottom: 0;">Hola, <span id="cupidoName"
                        style="color: var(--primary); font-weight: 600;">...</span> ‚ú®</p>
            </div>
            <div class="nav-actions">
                <button onclick="openModal()" class="btn-main" style="background: #4ade80;">+ Nueva Sala</button>
                <button onclick="logout()" class="btn-main btn-glass">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'cupido')">Cupido</button>
            <button class="tab-btn" onclick="switchTab(event, 'chats')">Mis chats</button>
        </div>

        <!-- Cupido Tab -->
        <div id="cupido-tab" class="tab-content active">
            <div id="roomsContainer" class="rooms-list-container">
                <div style="text-align: center; padding: 4rem; color: var(--text-dim);">
                    Cargando salas...
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button class="fab" onclick="openModal()">+</button>

        <!-- Mis Chats Tab -->
        <div id="chats-tab" class="tab-content" style="display: none;">
            <div id="recentsList" class="recents-grid"></div>
            <div id="noChatsMsg" style="padding: 5rem; text-align: center; display: none;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                <p style="color: var(--text-dim); font-size: 1.1rem;">No tienes chats guardados todav√≠a.</p>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Borrado -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="font-size: 3.5rem; margin-bottom: 1.5rem;">‚ö†Ô∏è</div>
            <h2 style="margin-bottom: 1rem; font-weight: 700;">¬øEst√°s seguro?</h2>
            <p style="color: var(--text-dim); margin-bottom: 2rem; line-height: 1.6;">Esta acci√≥n eliminar√° la sala
                permanentemente.</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="cancelDeleteBtn" class="btn-main btn-glass" style="flex: 1;">Cancelar</button>
                <button id="confirmDeleteBtn" class="btn-main" style="flex: 1; background: #ef4444;">Borrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Sala -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin-bottom: 2rem; text-align: center; font-weight: 700;">Crear Nueva Sala</h2>
            <form id="createRoomForm">
                <div class="form-row">
                    <div class="input-group">
                        <label>Nombre Amigo A</label>
                        <input type="text" id="friendA" required placeholder="Ej: Pedro">
                    </div>
                    <div class="input-group">
                        <label>Nombre Amigo B</label>
                        <input type="text" id="friendB" required placeholder="Ej: Sonia">
                    </div>
                </div>
                <button type="submit" class="btn-main" style="width: 100%; margin-top: 1rem;">Generar Sala y
                    Links</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let activeTimers = {};
        let roomTotals = {};
        let timerInterval = null;

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h}h ${m}m ${s}s`;
        }

        // --- UI Modal Logic ---
        function openModal() { document.getElementById('roomModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('roomModal').style.display = 'none'; }
        window.openModal = openModal;
        window.closeModal = closeModal;

        function switchTab(e, tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            e.currentTarget.classList.add('active');
            const target = document.getElementById(`${tab}-tab`);
            if (target) target.style.display = 'block';
            if (tab === 'chats') loadRecents();
        }
        window.switchTab = switchTab;

        // --- Data Loading ---
        async function loadUser() {
            try {
                const res = await fetch('/api/user');
                if (!res.ok) throw new Error("Auth failed");
                const data = await res.json();
                currentUser = data;
                document.getElementById('cupidoName').innerText = data.username;
                socket.emit('join-dashboard', { cupido_id: data.userId });
                await loadRooms();
            } catch (err) {
                console.error("User Load Error:", err);
                window.location.href = '/login';
            }
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms');
                if (!res.ok) throw new Error("Could not fetch rooms");
                const data = await res.json();
                const rooms = data.owned || [];

                const container = document.getElementById('roomsContainer');
                if (rooms.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding:5rem; color: var(--text-dim);">
                            <div style="font-size:3rem; margin-bottom:1rem;">üéØ</div>
                            <p>No hay salas creadas a√∫n.</p>
                            <p style="font-size:0.8rem; margin-top:0.5rem;">Pulsa el bot√≥n + para empezar</p>
                        </div>`;
                    return;
                }

                activeTimers = {};
                roomTotals = {};

                container.innerHTML = rooms.map(room => {
                    roomTotals[room.id] = room.total_active_seconds || 0;
                    if (room.active_since) activeTimers[room.id] = room.active_since;

                    let displayTime = formatTime(room.total_active_seconds || 0);
                    if (room.active_since) {
                        const currentDuration = Math.floor((Date.now() - room.active_since) / 1000) + (room.total_active_seconds || 0);
                        displayTime = formatTime(currentDuration);
                    }

                    return `
                    <div class="room-card" id="room-${room.id}">
                        <div class="room-header">
                            <div>
                                <div class="room-names">${room.friendA_name} & ${room.friendB_name}</div>
                                <div class="room-date">Creada el ${new Date(room.created_at).toLocaleDateString()}</div>
                            </div>
                            <span class="badge badge-${room.status.toLowerCase().replace(/ /g, '')}">${room.status}</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <div style="font-family: monospace; font-size: 1.2rem; font-weight: 600; color: var(--primary);">
                                ‚è±Ô∏è <span id="timer-${room.id}">${displayTime}</span>
                            </div>
                            <button class="delete-btn" onclick="deleteRoom(${room.id})" style="background:none; border:none; color:#ef4444; font-size:0.9rem; font-weight:600; cursor:pointer; opacity:0.7;">Borrar Sala</button>
                        </div>

                        <div class="link-pills">
                            <div class="pill ${room.linkA_used ? 'used' : ''}" onclick="copyToClipboard('${room.linkA}', this)">
                                <span>Para ${room.friendA_name}</span>
                                <span>${room.linkA_used ? '¬°Copiado!' : 'Copiar Link'}</span>
                            </div>
                            <div class="pill ${room.linkB_used ? 'used' : ''}" onclick="copyToClipboard('${room.linkB}', this)">
                                <span>Para ${room.friendB_name}</span>
                                <span>${room.linkB_used ? '¬°Copiado!' : 'Copiar Link'}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                if (!timerInterval) timerInterval = setInterval(updateTimersUI, 1000);
            } catch (e) {
                console.error("Load Rooms Error:", e);
                document.getElementById('roomsContainer').innerHTML = '<div style="color: #ef4444; padding: 2rem; text-align: center;">Error al cargar salas (ver consola)</div>';
            }
        }

        function updateTimersUI() {
            const now = Date.now();
            for (const [roomId, startTime] of Object.entries(activeTimers)) {
                const el = document.getElementById(`timer-${roomId}`);
                if (el) {
                    const elapsed = Math.floor((now - startTime) / 1000);
                    const total = (roomTotals[roomId] || 0) + elapsed;
                    el.innerText = formatTime(total);
                }
            }
        }

        // --- Operations ---
        let roomToDelete = null;
        function deleteRoom(id) {
            roomToDelete = id;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        window.deleteRoom = deleteRoom;

        document.getElementById('cancelDeleteBtn').onclick = () => {
            document.getElementById('confirmModal').style.display = 'none';
            roomToDelete = null;
        };

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!roomToDelete) return;
            const res = await fetch(`/api/rooms/${roomToDelete}`, { method: 'DELETE' });
            if (res.ok) {
                loadRooms();
                document.getElementById('confirmModal').style.display = 'none';
                roomToDelete = null;
            } else {
                alert("Error al borrar");
            }
        };

        document.getElementById('createRoomForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const friendA = document.getElementById('friendA').value;
            const friendB = document.getElementById('friendB').value;

            btn.disabled = true;
            btn.innerText = 'Generando...';

            try {
                const res = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ friendA_name: friendA, friendB_name: friendB })
                });
                if (res.ok) {
                    closeModal();
                    await loadRooms();
                    e.target.reset();
                } else {
                    alert("Error al crear la sala");
                }
            } catch (e) {
                alert("Error de red");
            } finally {
                btn.disabled = false;
                btn.innerText = 'Generar Sala y Links';
            }
        };

        async function copyToClipboard(text, btn) {
            const url = window.location.origin + '/chat/' + text;
            try {
                await navigator.clipboard.writeText(url);
                const span = btn.querySelector('span:last-child');
                const oldText = span.innerText;
                span.innerText = '¬°Copiado!';
                btn.classList.add('used');
                setTimeout(() => { span.innerText = oldText; }, 2000);
            } catch (err) {
                const el = document.createElement('textarea');
                el.value = url;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                const span = btn.querySelector('span:last-child');
                span.innerText = '¬°Copiado!';
                btn.classList.add('used');
            }
        }
        window.copyToClipboard = copyToClipboard;

        async function loadRecents() {
            try {
                const res = await fetch('/api/rooms');
                const data = await res.json();
                const accessed = data.accessed || [];
                const list = document.getElementById('recentsList');
                const msg = document.getElementById('noChatsMsg');

                if (accessed.length === 0) {
                    msg.style.display = 'block';
                    list.innerHTML = '';
                } else {
                    msg.style.display = 'none';
                    list.innerHTML = accessed.map(room => {
                        const link = (room.accessed_role === 'A') ? room.linkA : room.linkB;
                        const name = (room.accessed_role === 'A') ? room.friendB_name : room.friendA_name;
                        return `
                        <div class="recent-card" onclick="location.href='/chat/${link}'">
                            <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;">Chat con ${name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">Entrado: ${new Date(room.accessed_at).toLocaleString()}</div>
                            <div style="position: absolute; right: 1.5rem; bottom: 1.5rem; opacity: 0.2;">üí¨</div>
                        </div>`;
                    }).join('');
                }
            } catch (e) { console.error("Recents Error:", e); }
        }

        socket.on('status-change', ({ room_id, status }) => {
            const card = document.getElementById(`room-${room_id}`);
            if (card) {
                const badge = card.querySelector('.badge');
                if (badge) {
                    badge.className = `badge badge-${status.toLowerCase().replace(/ /g, '')}`;
                    badge.innerText = status;
                }
            }
        });

        socket.on('time-update', ({ room_id, active_since, added_seconds }) => {
            if (active_since) activeTimers[room_id] = active_since;
            else {
                delete activeTimers[room_id];
                if (added_seconds && roomTotals[room_id] !== undefined) {
                    roomTotals[room_id] += added_seconds;
                    const el = document.getElementById(`timer-${room_id}`);
                    if (el) el.innerText = formatTime(roomTotals[room_id]);
                }
            }
        });

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }
        window.logout = logout;

        loadUser();
    </script>
</body>

</html>