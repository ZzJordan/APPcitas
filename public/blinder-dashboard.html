<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Blinder Dashboard | Mis Chispazos</title>
    <link rel="stylesheet" href="/style.css?v=2.0">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .chispazo-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chispazo-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(255, 77, 109, 0.2);
        }

        .reveal-mini-timer {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem;
            display: none;
            z-index: 100;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
            animation: premiumFadeIn 0.3s ease-out;
        }

        .dropdown-item {
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.danger {
            color: #ff4d6d;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 77, 109, 0.1);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1">Mis Chispazos ‚ú®</h1>
            <div class="nav-actions">
                <button onclick="toggleSettings()" class="settings-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
                <div id="settingsMenu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="logout()">üö™ Salir</div>
                    <div class="dropdown-item danger" onclick="deleteAccount()">‚ö†Ô∏è Borrar Perfil</div>
                </div>
            </div>
        </header>

        <main>
            <div id="noChispazos" class="text-center p-3 hidden">
                <div class="hero-emoji">üåµ</div>
                <h2 class="mb-1">A√∫n no hay chispazos</h2>
                <p class="text-dim mb-2">Tu Cupido est√° trabajando en encontrarte el match ideal. ¬°Recibir√°s una
                    notificaci√≥n cuando suceda!</p>
                <button onclick="shareLink()" class="btn-main w-full">ü§ù Invitar a m√°s amigos</button>
            </div>

            <div id="chispazosContainer" class="chispazos-grid">
                <!-- Chispazos load here -->
            </div>
        </main>
    </div>

    <div id="notification" class="toast">¬°Nuevo chispazo detectado! ‚ö°</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activeRooms = [];

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('show');
        }

        // Close menu when clicking outside
        window.onclick = function (event) {
            if (!event.target.matches('.settings-btn')) {
                const menu = document.getElementById('settingsMenu');
                if (menu.classList.contains('show')) menu.classList.remove('show');
            }
        }

        async function loadDashboard() {
            try {
                // Get user info for socket notifications
                const userRes = await fetch('/api/user');
                const userData = await userRes.json();
                if (userData.userId) {
                    socket.emit('join-user', { userId: userData.userId });
                }

                const res = await fetch('/api/blinder/dashboard');
                const data = await res.json();

                if (!data.rooms || data.rooms.length === 0) {
                    document.getElementById('noChispazos').classList.remove('hidden');
                    document.getElementById('chispazosContainer').classList.add('hidden');
                } else {
                    document.getElementById('noChispazos').classList.add('hidden');
                    const container = document.getElementById('chispazosContainer');
                    container.classList.remove('hidden');
                    activeRooms = data.rooms;
                    renderRooms();
                }
            } catch (err) {
                console.error("Error al cargar dashboard:", err);
            }
        }

        function renderRooms() {
            const container = document.getElementById('chispazosContainer');
            container.innerHTML = activeRooms.map(room => `
                <div class="chispazo-card" id="room-${room.room_id}">
                    <div class="flex-center-y mb-1">
                        <div class="dot-pulse" style="display: ${room.status === 'activo' ? 'inline-block' : 'none'}"></div>
                        <span class="fs-small text-dim">${room.status.toUpperCase()}</span>
                    </div>
                    
                    <h3 class="mb-0">Match con ${room.other_name}</h3>
                    <p class="fs-small text-dim mb-1">Gu√≠a: ${room.cupido_name}</p>

                    <div class="text-center py-1">
                        <div class="reveal-mini-timer" id="timer-${room.room_id}">00:00:00</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill" id="progress-${room.room_id}" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="level-info mb-2">
                        <span>B√°sico</span>
                        <span>Visual</span>
                        <span>Full</span>
                    </div>

                    <button onclick="location.href='/chat/${room.link}'" class="btn-main w-full btn-glass">
                        üí¨ Entrar al Chat
                    </button>
                </div>
            `).join('');

            // Start individual timers
            updateAllTimers();
            setInterval(updateAllTimers, 1000);
        }

        function updateAllTimers() {
            activeRooms.forEach(room => {
                const timerEl = document.getElementById(`timer-${room.room_id}`);
                const progressEl = document.getElementById(`progress-${room.room_id}`);
                if (!timerEl || !progressEl) return;

                // Simple increment for client-side display (assuming 1s interval)
                room.active_seconds = (room.active_seconds || 0) + 1;

                const diffMin = room.active_seconds / 60;
                let targetMin = 0;
                if (diffMin < 15) targetMin = 15;
                else if (diffMin < 30) targetMin = 30;
                else targetMin = 30;

                const remainingSec = Math.max(0, (targetMin * 60) - room.active_seconds);
                const h = Math.floor(remainingSec / 3600);
                const m = Math.floor((remainingSec % 3600) / 60);
                const s = Math.floor(remainingSec % 60);

                if (diffMin >= 30) {
                    timerEl.innerText = "ACCESO TOTAL üî•";
                    progressEl.style.width = "100%";
                } else {
                    timerEl.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    progressEl.style.width = `${Math.min(100, (diffMin / 30) * 100)}%`;
                }
            });
        }

        // Notifications logic
        socket.on('new-chispazo', (data) => {
            showNotification();
            loadDashboard(); // Reload to show the new match
        });

        function showNotification() {
            const toast = document.getElementById('notification');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        async function shareLink() {
            const res = await fetch('/api/cupido/invite');
            const data = await res.json();
            if (navigator.share) {
                navigator.share({
                    title: '√önete a Cupido\'s Project',
                    text: 'Te invito a descubrir tus conexiones. ¬°Es gratis y viral!',
                    url: data.url
                });
            } else {
                prompt("Copia tu link de invitaci√≥n:", data.url);
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu perfil? Esta acci√≥n no se puede deshacer y perder√°s todos tus chispazos.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) {
                    alert("Perfil borrado con √©xito.");
                    location.href = '/login';
                } else {
                    alert("Error al borrar el perfil.");
                }
            }
        }

        loadDashboard();
    </script>
</body>

</html>