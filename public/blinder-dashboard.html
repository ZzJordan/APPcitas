<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Blinder Dashboard | Mis Chispazos</title>
    <link rel="stylesheet" href="/style.css?v=2.1">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .chispazo-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chispazo-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(255, 77, 109, 0.2);
        }

        .reveal-mini-timer {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem;
            display: none;
            z-index: 100;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
            animation: premiumFadeIn 0.3s ease-out;
        }

        .dropdown-item {
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.danger {
            color: #ff4d6d;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 77, 109, 0.1);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1" style="cursor: pointer;" onclick="location.href='/blinder-dashboard'">Mis
                Chispazos ‚ú®</h1>
            <div class="nav-actions">
                <button onclick="switchTab('profile')" class="settings-btn" title="Perfil">üë§</button>
            </div>
        </header>

        <main>
            <!-- Chispazos View -->
            <div id="roomsView" class="view-section">
                <div id="noChispazos" class="text-center p-3 hidden">
                    <div class="hero-emoji">üåµ</div>
                    <h2 class="mb-1">A√∫n no hay chispazos</h2>
                    <p class="text-dim mb-2">Tu Cupido est√° trabajando en encontrarte el match ideal. ¬°Recibir√°s una
                        notificaci√≥n cuando suceda!</p>
                    <button onclick="shareLink()" class="btn-main w-full">ü§ù Invitar a m√°s amigos</button>
                </div>

                <div id="chispazosContainer" class="chispazos-grid">
                    <!-- Chispazos load here -->
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="view-section" style="display: none;">
                <div class="glass-card text-center p-2 mb-2">
                    <div class="hero-emoji-main" style="font-size: 3rem;">‚ö°</div>
                    <h2 class="mb-1">Mi Perfil Blinder</h2>
                    <p class="text-dim mb-2">Gestiona tu experiencia.</p>

                    <div id="pwaInstallArea" class="glass-card install-card text-center p-2 mb-2">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì≤</div>
                        <h3 class="mb-1">Instalar App</h3>
                        <p class="text-dim fs-small mb-1">Instala para recibir notificaciones.</p>
                        <button id="installBtn" class="btn-main w-full">Instalar</button>
                    </div>

                    <button onclick="logout()" class="btn-main w-full mb-1 btn-glass">
                        üö™ Cerrar Sesi√≥n
                    </button>
                    <button onclick="deleteAccount()" class="btn-main w-full btn-danger">
                        ‚ö†Ô∏è Borrar Perfil
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('rooms')">
                <span class="nav-icon">‚ö°</span>
                <span>Chispazos</span>
            </button>
            <button class="nav-item" onclick="switchTab('profile')">
                <span class="nav-icon">üë§</span>
                <span>Perfil</span>
            </button>
        </div>
        </main>
    </div>

    <!-- PWA Install Popup -->
    <div id="pwaModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
        <div class="premium-card text-center"
            style="max-width: 90%; width: 350px; margin: 0; animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">üì≤</div>
            <h2 class="mb-1">Mejor Experiencia</h2>
            <p class="text-dim mb-2 fs-small">Instala la App para recibir notificaciones y acceder sin internet.</p>

            <button id="pwaInstallBtn" class="btn-main w-full mb-1">
                Instalar App
            </button>
            <button onclick="dismissPwa()" class="btn-main w-full btn-glass">
                Seguir en Navegador
            </button>
        </div>
    </div>

    <div id="notification" class="toast">¬°Nuevo chispazo detectado! ‚ö°</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activeRooms = [];

        // Prevent Back Navigation
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('show');
        }

        // Close menu when clicking outside
        // Close menu when clicking outside (removed menu logic, kept for cleanup if any fragments remain)
        function switchTab(tab) {
            const updateTab = () => {
                // Update Nav State
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                if (tab === 'rooms') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if (tab === 'profile') document.querySelectorAll('.nav-item')[1].classList.add('active');

                // View Logic
                document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

                if (tab === 'rooms') {
                    document.getElementById('roomsView').style.display = 'block';
                    loadDashboard(); // Refresh data
                } else {
                    document.getElementById('profileView').style.display = 'block';
                }
                triggerHaptic();
            };

            if (document.startViewTransition) {
                document.startViewTransition(updateTab);
            } else {
                updateTab();
            }
        }


        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        async function loadDashboard() {
            try {
                // Get user info for socket notifications
                const userRes = await fetch('/api/user');
                const userData = await userRes.json();
                if (userData.userId) {
                    socket.emit('join-user', { userId: userData.userId });
                }

                const res = await fetch('/api/blinder/dashboard');
                const data = await res.json();

                if (!data.rooms || data.rooms.length === 0) {
                    document.getElementById('noChispazos').innerHTML = `
                        <div class="empty-state-icon">üåµ</div>
                        <h2 class="mb-1">A√∫n no hay chispazos</h2>
                        <p class="text-dim mb-2">¬°Tu pr√≥xima conexi√≥n est√° cerca!</p>
                        <button onclick="shareLink()" class="btn-main w-full">ü§ù Compartir Perfil</button>`;
                    document.getElementById('noChispazos').classList.remove('hidden');
                    document.getElementById('chispazosContainer').classList.add('hidden');
                } else {
                    document.getElementById('noChispazos').classList.add('hidden');
                    const container = document.getElementById('chispazosContainer');
                    container.classList.remove('hidden');
                    activeRooms = data.rooms;
                    renderRooms();
                }
            } catch (err) {
                console.error("Error al cargar dashboard:", err);
            }
        }

        function renderRooms() {
            const container = document.getElementById('chispazosContainer');
            container.innerHTML = activeRooms.map(room => `
                <div class="chispazo-card" id="room-${room.room_id}">
                    <div class="flex-center-y mb-1">
                        <div class="dot-pulse" style="display: ${room.status === 'activo' ? 'inline-block' : 'none'}"></div>
                        <span class="fs-small text-dim">${room.status.toUpperCase()}</span>
                    </div>
                    
                    <h3 class="mb-0">Match con ${room.other_name}</h3>
                    <p class="fs-small text-dim mb-1">Gu√≠a: ${room.cupido_name}</p>

                    <div class="text-center py-1">
                        <div class="reveal-mini-timer" id="timer-${room.room_id}">00:00:00</div>
                        <div class="progress-bar mt-1">
                            <div class="progress-fill" id="progress-${room.room_id}" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="level-info mb-2">
                        <span>B√°sico</span>
                        <span>Visual</span>
                        <span>Full</span>
                    </div>

                    <button onclick="location.href='/chat/${room.link}'" class="btn-main w-full btn-glass">
                        üí¨ Entrar al Chat
                    </button>
                </div>
            `).join('');

            // Start individual timers
            updateAllTimers();
            setInterval(updateAllTimers, 1000);
        }

        function updateAllTimers() {
            activeRooms.forEach(room => {
                const timerEl = document.getElementById(`timer-${room.room_id}`);
                const progressEl = document.getElementById(`progress-${room.room_id}`);
                if (!timerEl || !progressEl) return;

                // Simple increment for client-side display (assuming 1s interval)
                room.active_seconds = (room.active_seconds || 0) + 1;

                const diffMin = room.active_seconds / 60;
                let targetMin = 0;
                if (diffMin < 15) targetMin = 15;
                else if (diffMin < 30) targetMin = 30;
                else targetMin = 30;

                const remainingSec = Math.max(0, (targetMin * 60) - room.active_seconds);
                const h = Math.floor(remainingSec / 3600);
                const m = Math.floor((remainingSec % 3600) / 60);
                const s = Math.floor(remainingSec % 60);

                if (diffMin >= 30) {
                    timerEl.innerText = "ACCESO TOTAL üî•";
                    progressEl.style.width = "100%";
                } else {
                    timerEl.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    progressEl.style.width = `${Math.min(100, (diffMin / 30) * 100)}%`;
                }
            });
        }

        // Notifications logic
        socket.on('new-chispazo', (data) => {
            showNotification();
            loadDashboard(); // Reload to show the new match
        });

        function showNotification() {
            const toast = document.getElementById('notification');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        async function shareLink() {
            const res = await fetch('/api/cupido/invite');
            const data = await res.json();
            if (navigator.share) {
                navigator.share({
                    title: '√önete a Cupido\'s Project',
                    text: 'Te invito a descubrir tus conexiones. ¬°Es gratis y viral!',
                    url: data.url
                });
            } else {
                prompt("Copia tu link de invitaci√≥n:", data.url);
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu perfil? Esta acci√≥n no se puede deshacer y perder√°s todos tus chispazos.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) {
                    alert("Perfil borrado con √©xito.");
                    location.href = '/login';
                } else {
                    alert("Error al borrar el perfil.");
                }
            }
        }

        loadDashboard();

        // PWA Install Logic
        let deferredPrompt;
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isAndroid = /android/.test(window.navigator.userAgent.toLowerCase());
        const isStandalone = ('standalone' in window.navigator && window.navigator.standalone) ||
            (window.matchMedia('(display-mode: standalone)').matches);

        function dismissPwa() {
            document.getElementById('pwaModal').style.display = 'none';
            sessionStorage.setItem('pwaDismissed', 'true');
        }

        function showManualInstructions() {
            const modal = document.getElementById('pwaModal');
            const title = modal.querySelector('h2');
            const text = modal.querySelector('p');
            const btn = document.getElementById('pwaInstallBtn');
            const icon = modal.querySelector('div');

            modal.style.display = 'flex';

            if (isIos) {
                icon.innerHTML = 'üçè';
                title.innerText = "Instalar en iPhone";
                text.innerHTML = "Toca <b>Compartir</b> <span style='font-size:1.2rem'>‚éã</span> y selecciona <b>'A√±adir a inicio'</b> ‚ûï";
                btn.innerText = "Entendido";
                btn.onclick = dismissPwa;
            } else {
                // Android / Generic Fallback
                icon.innerHTML = 'üì≤';
                title.innerText = "Instalar App";
                text.innerHTML = "Abre el men√∫ del navegador (<b>‚ãÆ</b> o <b>...</b>) y selecciona <b>'Instalar aplicaci√≥n'</b> o <b>'Agregar a inicio'</b>.";
                btn.innerText = "Entendido";
                btn.onclick = dismissPwa;
            }
        }

        // Logic to run on load
        if (!isStandalone) {
            // Always show profile button if not installed
            const installArea = document.getElementById('pwaInstallArea');
            if (installArea) installArea.style.display = 'block';

            // Handle Profile Button Click
            const profileBtn = document.getElementById('installBtn');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    if (deferredPrompt) triggerInstall();
                    else showManualInstructions();
                });
            }
        }

        // Listen for browser support
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show Popup if not dismissed recently (Auto-prompt logic)
            if (!sessionStorage.getItem('pwaDismissed') && !isStandalone) {
                setTimeout(() => {
                    // If we have the event, we show the "Automatic" popup version
                    const modal = document.getElementById('pwaModal');
                    const title = modal.querySelector('h2');
                    const text = modal.querySelector('p');
                    const btn = document.getElementById('pwaInstallBtn');

                    // Reset to default "Auto" state in case it was changed
                    title.innerText = "Mejor Experiencia";
                    text.innerHTML = "Instala la App para recibir notificaciones y acceder sin internet.";
                    btn.innerText = "Instalar App";
                    btn.onclick = triggerInstall;

                    modal.style.display = 'flex';
                }, 2000);
            }
        });

        // Trigger native prompt
        async function triggerInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwaModal').style.display = 'none';
                    const installArea = document.getElementById('pwaInstallArea');
                    if (installArea) installArea.style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        // iOS Immediate Check (since it won't fire beforeinstallprompt)
        if (isIos && !isStandalone && !sessionStorage.getItem('pwaDismissed')) {
            setTimeout(showManualInstructions, 3000);
        }
    </script>
</body>

</html>