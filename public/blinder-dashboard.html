<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Blinder Dashboard | Mis Flechazos</title>
    <link rel="stylesheet" href="/style.css?v=2.1">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .chispazo-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chispazo-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(255, 77, 109, 0.2);
        }

        .reveal-mini-timer {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem;
            display: none;
            z-index: 100;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
            animation: premiumFadeIn 0.3s ease-out;
        }

        .dropdown-item {
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.danger {
            color: #ff4d6d;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 77, 109, 0.1);
        }

        /* New Dashboard Styles */
        .dashboard-header h2 {
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            display: inline-block;
        }

        .status-dot.online {
            background: #4ade80;
            box-shadow: 0 0 8px #4ade80;
        }

        .cupido-badge {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .glass-inset {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-icon {
            width: 16px;
            height: 16px;
            background: var(--text-dim);
            color: black;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 4px;
        }

        /* Step Progress */
        .step-progress {
            position: relative;
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 10px;
        }

        .progress-line {
            position: absolute;
            top: 6px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            z-index: 0;
        }

        .progress-line .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 2px;
            transition: width 1s linear;
        }

        .step {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.5;
            transition: all 0.3s;
        }

        .step.active {
            opacity: 1;
        }

        .step-dot {
            width: 30px;
            height: 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .step.active .step-dot {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 10px rgba(255, 77, 109, 0.4);
        }

        .step-label {
            font-size: 0.7rem;
        }

        .shadow-lg {
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
        }

        .hover-scale:active {
            transform: scale(0.98);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out backwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1" style="cursor: pointer;" onclick="location.href='/blinder-dashboard'">Mis
                Flechazos üíò</h1>
            <div class="nav-actions">
                <button id="headerProfileBtn" onclick="toggleProfile()" class="settings-btn" title="Perfil">üë§</button>
            </div>
        </header>

        <main>
            <!-- Chispazos View -->
            <div id="roomsView" class="view-section">
                <div id="noChispazos" class="text-center p-3 hidden">
                    <div class="hero-emoji">üåµ</div>
                    <h2 class="mb-1">A√∫n no hay flechazos</h2>
                    <p class="text-dim mb-2">Tu Cupido est√° trabajando en encontrarte el match ideal. ¬°Recibir√°s una
                        notificaci√≥n cuando suceda!</p>
                    <button onclick="shareLink()" class="btn-main w-full">ü§ù Invitar a m√°s amigos</button>
                </div>

                <div id="chispazosContainer" class="chispazos-grid">
                    <!-- Chispazos load here -->
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="view-section" style="display: none;">
                <div class="glass-card text-center p-2 mb-2">
                    <div class="hero-emoji-main" style="font-size: 3rem;">‚ö°</div>
                    <h2 class="mb-1">Mi Perfil Blinder</h2>
                    <p class="text-dim mb-2">Gestiona tu experiencia.</p>

                    <div id="pwaInstallArea" class="glass-card install-card text-center p-2 mb-2">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì≤</div>
                        <h3 class="mb-1">Instalar App</h3>
                        <p class="text-dim fs-small mb-1">Instala para recibir notificaciones.</p>
                        <button id="installBtn" class="btn-main w-full">Instalar</button>
                    </div>

                    <button onclick="openEditProfile()" class="btn-main w-full mb-1 btn-glass"
                        style="border-color: var(--primary);">
                        ‚úèÔ∏è Editar Perfil
                    </button>

                    <div id="pushArea" class="glass-card text-center p-2 mb-2" style="display:none;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîî</div>
                        <h3 class="mb-1">Notificaciones</h3>
                        <p class="text-dim fs-small mb-1">Activa alertas para saber cuando te escriben.</p>
                        <button id="pushBtn" onclick="subscribeToPush()" class="btn-main w-full">Activar
                            Alertas</button>
                    </div>

                    <button onclick="logout()" class="btn-main w-full mb-1 btn-glass">
                        üö™ Cerrar Sesi√≥n
                    </button>
                    <button onclick="deleteAccount()" class="btn-main w-full btn-danger">
                        ‚ö†Ô∏è Borrar Perfil
                    </button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('rooms')">
                <span class="nav-icon">‚ö°</span>
                <span>Flechazos</span>
            </button>
            <button class="nav-item" onclick="switchTab('profile')">
                <span class="nav-icon">üë§</span>
                <span>Perfil</span>
            </button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
        <div class="premium-card" style="max-width: 90%; width: 400px; max-height: 90vh; overflow-y: auto;">
            <div class="flex-center-y justify-between mb-2">
                <h2 class="mb-0">Editar Perfil</h2>
                <button onclick="document.getElementById('editProfileModal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>

            <form id="editProfileForm">
                <div class="input-group mb-1">
                    <label>Nombre Completo</label>
                    <input type="text" id="editName" required class="input-glass w-full">
                </div>
                <div class="input-group mb-1">
                    <label>Email de Recuperaci√≥n</label>
                    <input type="email" id="editEmail" required class="input-glass w-full">
                </div>
                <div class="input-group mb-1">
                    <label>Tel√©fono</label>
                    <input type="tel" id="editTel" class="input-glass w-full">
                </div>
                <div class="input-group mb-2">
                    <label>URL Foto Perfil</label>
                    <input type="text" id="editPhoto" placeholder="https://..." class="input-glass w-full">
                </div>

                <button type="submit" class="btn-main w-full">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- PWA Install Popup -->
    <div id="pwaModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
        <div class="premium-card text-center"
            style="max-width: 90%; width: 350px; margin: 0; animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div id="pwaIcon" style="font-size: 3rem; margin-bottom: 0.5rem;">üì≤</div>
            <h2 class="mb-1">Mejor Experiencia</h2>
            <p class="text-dim mb-2 fs-small">Instala la App para recibir notificaciones y acceder sin internet.</p>

            <button id="pwaInstallBtn" class="btn-main w-full mb-1">
                Instalar App
            </button>
            <button onclick="dismissPwa()" class="btn-main w-full btn-glass">
                Seguir en Navegador
            </button>
        </div>
    </div>

    <div id="notification" class="toast">¬°Nuevo flechazo detectado! üíò</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activeRooms = [];

        // Prevent Back Navigation
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('show');
        }

        function toggleProfile() {
            const profileView = document.getElementById('profileView');
            if (profileView.style.display !== 'none') {
                switchTab('rooms');
            } else {
                switchTab('profile');
            }
        }

        // Close menu when clicking outside
        // Close menu when clicking outside (removed menu logic, kept for cleanup if any fragments remain)
        function switchTab(tab) {
            const updateTab = () => {
                // Update Nav State
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                if (tab === 'rooms') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if (tab === 'profile') document.querySelectorAll('.nav-item')[1].classList.add('active');

                // View Logic
                document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

                const headerBtn = document.getElementById('headerProfileBtn');

                if (tab === 'rooms') {
                    document.getElementById('roomsView').style.display = 'block';
                    if (headerBtn) headerBtn.innerText = 'üë§';
                    loadDashboard(); // Refresh data
                } else {
                    document.getElementById('profileView').style.display = 'block';
                    if (headerBtn) headerBtn.innerText = '‚úï';
                }
                triggerHaptic();
            };

            if (document.startViewTransition) {
                document.startViewTransition(updateTab);
            } else {
                updateTab();
            }
        }


        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        async function loadDashboard() {
            try {
                // Get user info for socket notifications
                const userRes = await fetch('/api/user');
                const userData = await userRes.json();
                if (userData.userId) {
                    socket.emit('join-user', { userId: userData.userId });
                }

                const res = await fetch('/api/blinder/dashboard');
                const data = await res.json();

                if (!data.rooms || data.rooms.length === 0) {
                    document.getElementById('noChispazos').innerHTML = `
                        <div class="empty-state-icon">üåµ</div>
                        <h2 class="mb-1">A√∫n no hay flechazos</h2>
                        <p class="text-dim mb-2">¬°Tu pr√≥xima conexi√≥n est√° cerca!</p>
                        <button onclick="shareLink()" class="btn-main w-full">ü§ù Compartir Perfil</button>`;
                    document.getElementById('noChispazos').classList.remove('hidden');
                    document.getElementById('chispazosContainer').classList.add('hidden');
                } else {
                    document.getElementById('noChispazos').classList.add('hidden');
                    const container = document.getElementById('chispazosContainer');
                    container.classList.remove('hidden');
                    activeRooms = data.rooms;
                    renderRooms();
                }
            } catch (err) {
                console.error("Error al cargar dashboard:", err);
            }
        }

        function renderRooms() {
            const container = document.getElementById('chispazosContainer');

            // Personal greeting (using first room's my_name if available, or just generic)
            const myName = activeRooms.length > 0 ? activeRooms[0].my_name : 'Blinder';
            const headerHTML = `
                <div class="dashboard-header mb-2 animate-fade-in">
                    <h2 class="fs-h1 mb-0">Hola, <span class="text-gradient">${myName}</span> üëã</h2>
                    <p class="text-dim">Aqu√≠ est√°n tus conexiones activas.</p>
                </div>
            `;

            const roomsHTML = activeRooms.map(room => `
                <div class="chispazo-card animate-slide-up" id="room-${room.room_id}">
                    <div class="card-header flex-center-y justify-between mb-1">
                        <div class="flex-center-y gap-2">
                             <div class="avatar-small" style="background: ${room.status === 'activo' ? 'var(--primary-gradient)' : 'var(--glass)'}">
                                ${room.other_name.charAt(0)}
                             </div>
                             <div>
                                <h3 class="mb-0 fs-large">${room.other_name}</h3>
                                <div class="flex-center-y gap-1">
                                    <span class="status-dot ${room.status === 'activo' ? 'online' : ''}"></span>
                                    <span class="fs-small text-dim">${room.status === 'activo' ? 'En l√≠nea ahora' : 'Desconectado'}</span>
                                </div>
                             </div>
                        </div>
                        <div class="cupido-badge" title="Cupido asignado">
                            üíò ${room.cupido_name}
                        </div>
                    </div>

                    <div class="level-progress-container mb-2 p-1 glass-inset">
                        <div class="flex-center-y justify-between mb-1">
                             <span class="fs-small font-bold flex-center-y gap-1">
                                ‚è≥ Nivel de Revelaci√≥n
                                <span class="info-icon" onclick="showTimerInfo()">?</span>
                             </span>
                             <span class="fs-mono fs-small" id="timer-${room.room_id}">00:00:00</span>
                        </div>
                        
                        <div class="step-progress">
                            <div class="step ${room.active_seconds >= 0 ? 'active' : ''}">
                                <div class="step-dot">Start</div>
                            </div>
                            <div class="step ${room.active_seconds >= 900 ? 'active' : ''}">
                                <div class="step-dot">15m</div>
                                <span class="step-label">Fotos</span>
                            </div>
                             <div class="step ${room.active_seconds >= 1800 ? 'active' : ''}">
                                <div class="step-dot">30m</div>
                                <span class="step-label">Datos</span>
                            </div>
                            <div class="progress-line">
                                <div class="progress-fill" id="progress-${room.room_id}" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <button onclick="location.href='/chat/${room.link}'" class="btn-main w-full shadow-lg hover-scale">
                        üí¨ Chatear con ${room.other_name}
                    </button>
                </div>
            `).join('');

            container.innerHTML = headerHTML + roomsHTML;

            // Start individual timers
            updateAllTimers();
            // Clear existing interval to avoid duplicates if re-rendering
            if (window.timerInterval) clearInterval(window.timerInterval);
            window.timerInterval = setInterval(updateAllTimers, 1000);
        }

        function showTimerInfo() {
            alert("‚è∞ El contador avanza solo cuando AMBOS est√°n conectados en el chat.\n\n‚Ä¢ 15 min: Se revelan fotos borrosas.\n‚Ä¢ 30 min: Se revelan datos de contacto y fotos reales.\n\n¬°Invita a la otra persona a conectarse!");
        }

        function updateAllTimers() {
            activeRooms.forEach(room => {
                const timerEl = document.getElementById(`timer-${room.room_id}`);
                const progressEl = document.getElementById(`progress-${room.room_id}`);
                if (!timerEl || !progressEl) return;

                // Simple increment for client-side display (assuming 1s interval)
                // Note: Real sync updates on page reload or socket event, this is visual only
                if (room.status === 'activo') {
                    room.active_seconds = (room.active_seconds || 0) + 1;
                }

                const diffMin = room.active_seconds / 60;

                // Progress is based on 30 mins cap
                const progressPct = Math.min(100, (room.active_seconds / 1800) * 100);

                const h = Math.floor(room.active_seconds / 3600);
                const m = Math.floor((room.active_seconds % 3600) / 60);
                const s = Math.floor(room.active_seconds % 60);

                if (diffMin >= 30) {
                    timerEl.innerText = "üîì DESBLOQUEADO";
                    timerEl.style.color = "#4ade80";
                    progressEl.style.width = "100%";
                    progressEl.style.background = "#4ade80";
                } else {
                    timerEl.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    progressEl.style.width = `${progressPct}%`;
                }
            });
        }

        // Notifications logic
        socket.on('new-chispazo', (data) => {
            showNotification();
            loadDashboard(); // Reload to show the new match
        });

        function showNotification() {
            const toast = document.getElementById('notification');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        async function shareLink() {
            const res = await fetch('/api/cupido/invite');
            const data = await res.json();
            if (navigator.share) {
                navigator.share({
                    title: '√önete a Cupido\'s Project',
                    text: 'Te invito a descubrir tus conexiones. ¬°Es gratis y viral!',
                    url: data.url
                });
            } else {
                prompt("Copia tu link de invitaci√≥n:", data.url);
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu perfil? Esta acci√≥n no se puede deshacer y perder√°s todos tus flechazos.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) {
                    alert("Perfil borrado con √©xito.");
                    location.href = '/login';
                } else {
                    alert("Error al borrar el perfil.");
                }
            }
        }

        // --- Edit Profile Logic ---
        async function openEditProfile() {
            const modal = document.getElementById('editProfileModal');
            modal.style.display = 'flex';

            try {
                const res = await fetch('/api/user/profile');
                if (!res.ok) throw new Error("Error fetching profile");
                const data = await res.json();

                document.getElementById('editName').value = data.full_name || '';
                document.getElementById('editEmail').value = data.email || '';
                document.getElementById('editTel').value = data.tel || '';
                document.getElementById('editPhoto').value = data.photo_url || '';
            } catch (e) {
                console.error(e);
                alert("Error cargando perfil");
                modal.style.display = 'none';
            }
        }

        document.getElementById('editProfileForm').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                full_name: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                tel: document.getElementById('editTel').value,
                photo_url: document.getElementById('editPhoto').value
            };

            try {
                const res = await fetch('/api/user/profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Perfil actualizado correctamente");
                    document.getElementById('editProfileModal').style.display = 'none';
                    loadDashboard(); // Refresh name
                } else {
                    const d = await res.json();
                    alert("Error: " + (d.error || 'Desconocido'));
                }
            } catch (e) {
                alert("Error de conexi√≥n");
            }
        };

        loadDashboard();

        // PWA Install Logic
        let deferredPrompt;
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isAndroid = /android/.test(window.navigator.userAgent.toLowerCase());
        const isStandalone = ('standalone' in window.navigator && window.navigator.standalone) ||
            (window.matchMedia('(display-mode: standalone)').matches);

        function dismissPwa() {
            document.getElementById('pwaModal').style.display = 'none';
            sessionStorage.setItem('pwaDismissed', 'true');
        }

        function showManualInstructions() {
            const modal = document.getElementById('pwaModal');
            const title = modal.querySelector('h2');
            const text = modal.querySelector('p');
            const btn = document.getElementById('pwaInstallBtn');
            const icon = document.getElementById('pwaIcon');

            modal.style.display = 'flex';

            if (isIos) {
                icon.innerHTML = 'üçè';
                title.innerText = "Instalar en iPhone";
                text.innerHTML = "Toca <b>Compartir</b> <span style='font-size:1.2rem'>‚éã</span> y selecciona <b>'A√±adir a inicio'</b> ‚ûï";
                btn.innerText = "Entendido";
                btn.onclick = dismissPwa;
            } else {
                // Android / Generic Fallback
                icon.innerHTML = 'üì≤';
                title.innerText = "Instalar App";
                text.innerHTML = "Abre el men√∫ del navegador (<b>‚ãÆ</b> o <b>...</b>) y selecciona <b>'Instalar aplicaci√≥n'</b> o <b>'Agregar a inicio'</b>.";
                btn.innerText = "Entendido";
                btn.onclick = dismissPwa;
            }
        }

        // Logic to run on load
        if (!isStandalone) {
            // Always show profile button if not installed
            const installArea = document.getElementById('pwaInstallArea');
            if (installArea) installArea.style.display = 'block';

            // Handle Profile Button Click
            const profileBtn = document.getElementById('installBtn');
            if (profileBtn) {
                profileBtn.addEventListener('click', () => {
                    if (deferredPrompt) triggerInstall();
                    else showManualInstructions();
                });
            }
        }

        // Listen for browser support
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show Popup if not dismissed recently (Auto-prompt logic)
            if (!sessionStorage.getItem('pwaDismissed') && !isStandalone) {
                setTimeout(() => {
                    // If we have the event, we show the "Automatic" popup version
                    const modal = document.getElementById('pwaModal');
                    const title = modal.querySelector('h2');
                    const text = modal.querySelector('p');
                    const btn = document.getElementById('pwaInstallBtn');

                    // Reset to default "Auto" state in case it was changed
                    title.innerText = "Mejor Experiencia";
                    text.innerHTML = "Instala la App para recibir notificaciones y acceder sin internet.";
                    btn.innerText = "Instalar App";
                    btn.onclick = triggerInstall;

                    modal.style.display = 'flex';
                }, 2000);
            }
        });

        // Trigger native prompt
        async function triggerInstall() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('pwaModal').style.display = 'none';
                    const installArea = document.getElementById('pwaInstallArea');
                    if (installArea) installArea.style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        // Universal Fallback (if native event doesn't fire)
        if (!isStandalone && !sessionStorage.getItem('pwaDismissed')) {
            setTimeout(() => {
                if (!deferredPrompt && document.getElementById('pwaModal').style.display === 'none') {
                    showManualInstructions();
                }
            }, 4000); // 4s wait
        }

        // --- Push Logic ---
        async function subscribeToPush() {
            const btn = document.getElementById('pushBtn');
            btn.disabled = true;
            btn.innerText = "Activando...";

            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                alert("Tu navegador no soporta notificaciones push.");
                return;
            }

            try {
                // 1. Get Key
                const keyRes = await fetch('/api/vapid-key');
                const { publicKey } = await keyRes.json();

                // 2. Request Permission
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    alert("Permiso denegado.");
                    btn.innerText = "Activar Alertas";
                    btn.disabled = false;
                    return;
                }

                // 3. Register SW (if not already) & Subscribe
                const reg = await navigator.serviceWorker.ready;
                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicKey)
                });

                // 4. Send to Backend
                await fetch('/api/subscribe', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: { 'Content-Type': 'application/json' }
                });

                alert("¬°Notificaciones activadas! üîî");
                document.getElementById('pushArea').style.display = 'none'; // Hide after success

            } catch (err) {
                console.error(err);
                alert("Error al activar notificaciones.");
                btn.innerText = "Reintentar";
                btn.disabled = false;
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Check if already subscribed to show/hide button
        (async () => {
            if ('serviceWorker' in navigator && 'PushManager' in window && Notification.permission !== 'denied') {
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.getSubscription();
                if (!sub) {
                    document.getElementById('pushArea').style.display = 'block';
                }
            }
        })();
    </script>
    <script src="/notifications.js"></script>
</body>

</html>