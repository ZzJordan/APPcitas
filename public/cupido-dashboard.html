<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cupido Dashboard | Gesti√≥n de Conexiones</title>
    <link rel="stylesheet" href="/style.css?v=2.1">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ff4d6d">
    <link rel="apple-touch-icon" href="/app-icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0.5rem;
            display: none;
            z-index: 100;
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.show {
            display: block;
            animation: premiumFadeIn 0.3s ease-out;
        }

        .dropdown-item {
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.danger {
            color: #ff4d6d;
        }

        .dropdown-item.danger:hover {
            background: rgba(255, 77, 109, 0.1);
        }
    </style>

</head>

<body>
    <div class="app-container">
        <header class="nav">
            <h1 class="text-left fs-h1" style="cursor: pointer;" onclick="location.href='/cupido-dashboard'">Panel
                Cupido ‚ú®</h1>
            <div class="nav-actions">
                <button onclick="switchTab('profile')" class="settings-btn" title="Perfil">üë§</button>
            </div>

        </header>

        <main>
            <!-- Views Container -->
            <div id="roomsView" class="view-section">
                <div class="p-2 mb-2 glass-dashed text-center">
                    <button onclick="openModal()" class="btn-main w-full">
                        <span>+ Nueva Conexi√≥n</span>
                    </button>
                </div>
                <div id="roomsList">
                    <!-- Salas load here -->
                    <div class="text-center text-dim p-3">
                        Cargando salas...
                    </div>
                </div>
            </div>

            <div id="blindersView" class="view-section" style="display: none;">
                <div class="import-section glass-dashed p-2 mb-2 text-center">
                    <h3>Generar Invitaci√≥n Viral</h3>
                    <p class="fs-small mb-1 mt-1 text-dim">
                        Crea un enlace para que tus amigos se unan como Blindres.</p>
                    <button id="inviteBtn" onclick="generateInvite()" class="btn-main w-full">
                        <span>Generar Link de Invitaci√≥n</span>
                    </button>
                    <div id="inviteResult" class="mt-1 hidden">
                        <input type="text" id="inviteUrl" readonly class="input-glass mb-1 fs-small text-center">
                        <button onclick="copyInvite()" class="btn-main btn-glass w-full">Copiar y Compartir</button>
                    </div>

                </div>

                <div id="blindersList">
                    <!-- Blinders load here -->
                    <div class="text-center text-dim p-3">
                        Cargando blinders...
                    </div>
                </div>

            </div>
    </div>

    <div id="profileView" class="view-section" style="display: none;">
        <div class="glass-card text-center p-2 mb-2">
            <div class="hero-emoji-main" style="font-size: 3rem;">üë§</div>
            <h2 class="mb-1">Mi Cuenta Cupido</h2>
            <p class="text-dim mb-2">Gestiona tu suscripci√≥n y ajustes.</p>

            <div id="pwaInstallArea" class="glass-card install-card text-center p-2 mb-2">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì≤</div>
                <h3 class="mb-1">Instalar App</h3>
                <p class="text-dim fs-small mb-1">Instala Cupido's Project en tu inicio para acceso r√°pido.</p>
                <button id="installBtn" class="btn-main w-full">Instalar Ahora</button>
            </div>

            <div id="pushArea" class="glass-card text-center p-2 mb-2" style="display:none;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üîî</div>
                <h3 class="mb-1">Notificaciones</h3>
                <p class="text-dim fs-small mb-1">Activa alertas para saber cuando te escriben.</p>
                <button id="pushBtn" onclick="subscribeToPush()" class="btn-main w-full">Activar Alertas</button>
            </div>

            <button onclick="logout()" class="btn-main w-full mb-1 btn-glass">
                üö™ Cerrar Sesi√≥n
            </button>
            <button onclick="deleteAccount()" class="btn-main w-full btn-danger">
                ‚ö†Ô∏è Eliminar Cuenta
            </button>
        </div>
    </div>
    </main>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('rooms')">
            <span class="nav-icon">üí¨</span>
            <span>Salas</span>
        </button>
        <button class="nav-item" onclick="switchTab('blinders')">
            <span class="nav-icon">üë•</span>
            <span>Blinders</span>
        </button>
        <button class="nav-item" onclick="switchTab('profile')">
            <span class="nav-icon">üë§</span>
            <span>Perfil</span>
        </button>
    </div>
    </div>

    <!-- Create Room Modal -->
    <div id="roomModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div class="premium-card" style="max-width: 90%; width: 400px; margin: 0; position: relative;">
            <span class="close-modal" onclick="closeModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer;">&times;</span>
            <h2 style="margin-bottom: 2rem; text-align: center; font-weight: 700;">Nueva Conexi√≥n</h2>
            <form id="createRoomForm">
                <div class="input-group">
                    <label>Persona A</label>
                    <input type="text" id="friendA" required placeholder="Ej: Juan">
                </div>
                <div class="input-group">
                    <label>Persona B</label>
                    <input type="text" id="friendB" required placeholder="Ej: Sonia">
                </div>
                <button type="submit" class="btn-main w-full mt-1">Crear Sala</button>
            </form>
        </div>
    </div>

    <!-- PWA Install Popup -->
    <div id="pwaModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;">
        <div class="premium-card text-center"
            style="max-width: 90%; width: 350px; margin: 0; animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
            <div id="pwaIcon" style="font-size: 3rem; margin-bottom: 0.5rem;">üì≤</div>
            <h2 class="mb-1">Mejor Experiencia</h2>
            <p class="text-dim mb-2 fs-small">Instala la App para recibir notificaciones y acceder sin internet.</p>

            <button id="pwaInstallBtn" class="btn-main w-full mb-1">
                Instalar App
            </button>
            <button onclick="dismissPwa()" class="btn-main w-full btn-glass">
                Seguir en Navegador
            </button>
        </div>
    </div>

    <!-- Room Info Modal -->
    <div id="infoModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center;">
        <div class="premium-card" style="max-width: 90%; width: 350px; margin: 0; position: relative;">
            <span class="close-modal" onclick="closeInfoModal()"
                style="position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer;">&times;</span>
            <h2 class="mb-2 text-center">Detalles de Sala</h2>

            <div id="infoContent" style="text-align: left;">
                <!-- Content injected via JS -->
            </div>

            <button onclick="closeInfoModal()" class="btn-main w-full mt-2">Cerrar</button>
        </div>
    </div>

    <script>
        const socket = io();
        const roomsList = document.getElementById('roomsList');
        const blindersList = document.getElementById('blindersList');
        let currentRooms = [];

        // Identify for Global Notifications
        fetch('/api/user').then(r => r.json()).then(user => {
            if (user.userId) socket.emit('join-user', { userId: user.userId });
            if (user.userId) socket.emit('join-dashboard', { cupido_id: user.userId });
        }).catch(e => console.warn(e));

        // Modal Logic
        function openModal() { document.getElementById('roomModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('roomModal').style.display = 'none'; }
        function closeInfoModal() { document.getElementById('infoModal').style.display = 'none'; }

        window.openModal = openModal;
        window.closeModal = closeModal;
        window.closeInfoModal = closeInfoModal;

        // Prevent Back Navigation
        history.pushState(null, null, location.href);
        window.onpopstate = function () {
            history.go(1);
        };

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('show');
        }

        window.onclick = function (event) {
            if (!event.target.matches('.settings-btn')) {
                const menu = document.getElementById('settingsMenu');
                if (menu && menu.classList.contains('show')) menu.classList.remove('show');
            }
        }

        // Haptic Feedback Helper
        function triggerHaptic() {
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function switchTab(tab) {
            const updateTab = () => {
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                if (tab === 'rooms') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if (tab === 'blinders') document.querySelectorAll('.nav-item')[1].classList.add('active');
                if (tab === 'profile') document.querySelectorAll('.nav-item')[2].classList.add('active');

                document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');

                if (tab === 'rooms') {
                    document.getElementById('roomsView').style.display = 'block';
                    loadRooms();
                } else if (tab === 'blinders') {
                    document.getElementById('blindersView').style.display = 'block';
                    loadBlinders();
                } else if (tab === 'profile') {
                    document.getElementById('profileView').style.display = 'block';
                }
                triggerHaptic();
            };

            if (document.startViewTransition) {
                document.startViewTransition(updateTab);
            } else {
                updateTab();
            }
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms');
                const data = await res.json();
                roomsList.innerHTML = data.owned.map(r => `
                    <div class="room-card" id="room-${r.id}">
                        <div class="room-header">
                            <div class="room-names">${r.friendA_name} ‚Üî ${r.friendB_name}</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="badge badge-${r.status.toLowerCase().replace(' ', '')}" id="status-${r.id}">${r.status}</div>
                                <button onclick="showRoomInfo('${r.id}')" style="background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center;">‚ÑπÔ∏è</button>
                            </div>
                        </div>
                        <div class="link-pills">
                            <div class="pill ${r.linkA_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkA}')">
                                <span>${r.friendA_name}</span>
                                <span>Copiar Link</span>
                            </div>
                            <div class="pill ${r.linkB_used ? 'used' : ''}" onclick="copyUrl('/chat/${r.linkB}')">
                                <span>${r.friendB_name}</span>
                                <span>Copiar Link</span>
                            </div>
                        </div>
                        <button onclick="shareRoom('${r.id}')" class="btn-main btn-glass w-full mt-1" style="font-size: 0.9rem; padding: 0.6rem;">
                            üîó Compartir Acceso a Sala
                        </button>
                    </div>
                `).join('');
                if (data.owned.length === 0) {
                    roomsList.innerHTML = `
                        <div class="text-center p-3">
                            <div class="empty-state-icon">üï∏Ô∏è</div>
                            <p class="text-dim">Tu red est√° tranquila...</p>
                            <p class="fs-small text-dim">¬°Crea una nueva sala para empezar la magia!</p>
                        </div>`;
                }
                currentRooms = data.owned;
            } catch (err) { console.error(err); }
        }

        async function shareRoom(roomId) {
            try {
                const res = await fetch(`/api/rooms/${roomId}/share`, { method: 'POST' });
                if (!res.ok) return alert("Error al generar enlace.");
                const data = await res.json();
                if (data.url) {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: 'Acceso a Sala - Cupido',
                                text: 'Enlace de acceso para colaborar en esta sala:',
                                url: data.url
                            });
                            return;
                        } catch (err) { }
                    }
                    await navigator.clipboard.writeText(data.url);
                    triggerHaptic();
                    alert("Enlace copiado al portapapeles.");
                }
            } catch (e) { console.error(e); }
        }

        function showRoomInfo(roomId) {
            const room = currentRooms.find(r => r.id == roomId);
            if (!room) return;
            const createdDate = new Date(room.created_at).toLocaleDateString();
            document.getElementById('infoContent').innerHTML = `
                <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid var(--border);">
                    <p class="mb-1"><strong class="text-dim">ID Sala:</strong> <span style="font-family: monospace;">${room.id.substring(0, 8)}...</span></p>
                    <p class="mb-1"><strong class="text-dim">Creada:</strong><br>${createdDate}</p>
                    <p class="mb-1"><strong class="text-dim">Participantes:</strong><br>
                        ‚ú® ${room.friendA_name}<br>
                        üî• ${room.friendB_name}
                    </p>
                    <p class="mb-0"><strong class="text-dim">Estado Actual:</strong> <span class="text-success">${room.status.toUpperCase()}</span></p>
                </div>
            `;
            document.getElementById('infoModal').style.display = 'flex';
        }

        async function loadBlinders() {
            try {
                const res = await fetch('/api/cupido/blinders');
                const blinders = await res.json();
                blindersList.innerHTML = blinders.map(b => `
                    <div class="room-card">
                        <div style="display: flex; align-items: center; gap: 1.2rem;">
                            <div style="width: 65px; height: 65px; border-radius: 50%; overflow: hidden; background: var(--glass); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;">
                                ${b.photo_url ? `<img src="${b.photo_url}" style="width:100%; height:100%; object-fit:cover;">` : '<span style="font-size: 1.5rem;">üë§</span>'}
                            </div>
                            <div style="flex:1;">
                                <div style="font-weight: 700; font-size: 1.1rem;">${b.full_name} ${b.revealLevel >= 3 ? `(${b.age})` : ''}</div>
                                <div style="font-size: 0.85rem; color: var(--text-dim); font-style: italic; margin-top: 2px;">"${b.tagline}"</div>
                            </div>
                            <div class="badge badge-activo" style="font-size: 0.7rem;">Lvl ${b.revealLevel}</div>
                        </div>
                    </div>
                `).join('');
                if (blinders.length === 0) {
                    blindersList.innerHTML = `
                        <div class="text-center p-3">
                            <div class="empty-state-icon">üëª</div>
                            <p class="text-dim">No tienes blinders a√∫n.</p>
                            <p class="fs-small text-dim">¬°Comparte tu link viral para atraer solteros!</p>
                        </div>`;
                }
            } catch (err) { console.error(err); }
        }

        async function generateInvite() {
            const btn = document.getElementById('inviteBtn');
            btn.disabled = true;
            btn.innerText = "Generando...";
            try {
                const res = await fetch('/api/cupido/invite');
                const data = await res.json();
                document.getElementById('inviteUrl').value = data.url;
                document.getElementById('inviteResult').style.display = 'block';
                btn.innerText = "¬°Link Generado!";
            } catch (err) {
                alert("Error al generar invitaci√≥n");
                btn.disabled = false;
                btn.innerText = "Generar Link de Invitaci√≥n";
            }
        }

        function copyInvite() {
            const url = document.getElementById('inviteUrl').value;
            navigator.clipboard.writeText(url);
            triggerHaptic();
            alert("Link copiado al portapapeles.");
        }

        function copyUrl(path) {
            const fullUrl = window.location.origin + path;
            navigator.clipboard.writeText(fullUrl);
            triggerHaptic();
            alert("Enlace de chat copiado");
        }

        async function deleteAccount() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres borrar tu cuenta? Esta acci√≥n es definitiva.")) {
                const res = await fetch('/api/user/delete-account', { method: 'POST' });
                if (res.ok) location.href = '/login';
            }
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = '/login';
        }

        document.getElementById('createRoomForm').onsubmit = async (e) => {
            e.preventDefault();
            const friendA = document.getElementById('friendA').value;
            const friendB = document.getElementById('friendB').value;
            try {
                const res = await fetch('/api/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ friendA_name: friendA, friendB_name: friendB })
                });
                if (res.ok) {
                    closeModal();
                    loadRooms();
                    e.target.reset();
                }
            } catch (e) { }
        };

        socket.on('status-change', ({ room_id, status }) => {
            const badge = document.getElementById(`status-${room_id}`);
            if (badge) {
                badge.innerText = status;
                badge.className = `badge badge-${status.toLowerCase().replace(' ', '')}`;
            }
        });

        socket.on('link-regenerated', ({ room_id }) => {
            if (document.getElementById('roomsView').style.display === 'block') loadRooms();
        });

        // PWA logic simplified
        let deferredPrompt;
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        function dismissPwa() { document.getElementById('pwaModal').style.display = 'none'; sessionStorage.setItem('pwaDismissed', 'true'); }
        function showManualInstructions() {
            const modal = document.getElementById('pwaModal');
            document.getElementById('pwaIcon').innerHTML = isIos ? 'üçè' : 'üì≤';
            modal.querySelector('h2').innerText = isIos ? "Instalar en iPhone" : "Instalar App";
            modal.querySelector('p').innerHTML = isIos ? "Toca <b>Compartir</b> y selecciona <b>'A√±adir al inicio'</b>" : "Usa el men√∫ del navegador para instalar.";
            document.getElementById('pwaInstallBtn').innerText = "Entendido";
            document.getElementById('pwaInstallBtn').onclick = dismissPwa;
            modal.style.display = 'flex';
        }

        if (!isStandalone) document.getElementById('pwaInstallArea').style.display = 'block';
        document.getElementById('installBtn').onclick = () => { if (deferredPrompt) deferredPrompt.prompt(); else showManualInstructions(); };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!sessionStorage.getItem('pwaDismissed') && !isStandalone) {
                setTimeout(() => { document.getElementById('pwaModal').style.display = 'flex'; }, 2000);
            }
        });

        // Push functions
        async function subscribeToPush() {
            try {
                const keyRes = await fetch('/api/vapid-key');
                const { publicKey } = await keyRes.json();
                const reg = await navigator.serviceWorker.ready;
                const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) });
                await fetch('/api/subscribe', { method: 'POST', body: JSON.stringify(sub), headers: { 'Content-Type': 'application/json' } });
                alert("¬°Notificaciones activadas! üîî");
                document.getElementById('pushArea').style.display = 'none';
            } catch (err) { console.error(err); }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        (async () => {
            if ('serviceWorker' in navigator && 'PushManager' in window && Notification.permission !== 'denied') {
                const reg = await navigator.serviceWorker.ready;
                if (!(await reg.pushManager.getSubscription())) document.getElementById('pushArea').style.display = 'block';
            }
        })();

        switchTab('rooms');
    </script>
    <script src="/notifications.js"></script>
</body>

</html>